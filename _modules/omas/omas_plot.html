
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>omas.omas_plot &#8212; OMAS</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><img height=40, src="../../_static/OMAS_logo.png">
          <!-- OMAS-->
        </a>
        <!-- <span class="navbar-text navbar-version pull-left"><b></b></span> -->
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../how.html">Concept</a></li>
                <li><a href="../../auto_examples/index.html">Examples</a></li>
                <li><a href="../../install.html">Installation</a></li>
                <li><a href="../../iter.html">ITER</a></li>
                <li><a href="../../omfit.html">OMFIT</a></li>
                <li><a href="../../schema.html">Data schema</a></li>
                <li><a href="../../code.html">API</a></li>
            
            
              
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">In this page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>
           <!-- 
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
           -->
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for omas.omas_plot</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;plotting ODS methods and utilities</span>

<span class="sd">-------</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">from</span> <span class="nn">.omas_utils</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.omas_physics</span> <span class="k">import</span> <span class="n">cocos_transform</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">__ods__</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">add_to__ODS__</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    anything wrapped here will be available as a ODS method with name &#39;plot_&#39;+f.__name__</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">__ods__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">add_to__ALL__</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="c1"># ================================</span>
<span class="c1"># plotting helper functions</span>
<span class="c1"># ================================</span>

<span class="k">def</span> <span class="nf">uerrorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given arguments y or x,y where x and/or y have uncertainties, feed the</span>
<span class="sd">    appropriate terms to matplotlib&#39;s errorbar function.</span>

<span class="sd">    If y or x is more than 1D, it is flattened along every dimension but the last.</span>

<span class="sd">    :param x: array of independent axis values</span>

<span class="sd">    :param y: array of values with uncertainties, for which shaded error band is plotted</span>

<span class="sd">    :param ax: The axes instance into which to plot (default: gca())</span>

<span class="sd">    :param \**kwargs: Passed to ax.errorbar</span>

<span class="sd">    :return: list. A list of ErrorbarContainer objects containing the line, bars, and caps of each (x,y) along the last dimension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># set default key word arguments</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">gca</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;linestyle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="s1">&#39;ls&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;linestyle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">std_devs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">std_devs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;capsize&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># enable combinations of 1D and 2D x&#39;s and y&#39;s</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># one x for all y&#39;s</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># plot each (x,y) and collect container objects</span>
    <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span>
                          <span class="n">nominal_values</span><span class="p">(</span><span class="n">yi</span><span class="p">),</span> <span class="n">xerr</span><span class="o">=</span><span class="n">std_devs</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span>
                          <span class="n">yerr</span><span class="o">=</span><span class="n">std_devs</span><span class="p">(</span><span class="n">yi</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">Uband</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class wraps the line and PollyCollection(s) associated with a banded</span>
<span class="sd">    errorbar plot for use in the uband function.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">bands</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param line: Line2D</span>
<span class="sd">            A line of the x,y nominal values</span>

<span class="sd">        :param bands: list of PolyCollections</span>
<span class="sd">            The fill_between and/or fill_betweenx PollyCollections spanning the std_devs of the x,y data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matplotlib.cbook</span> <span class="k">import</span> <span class="n">flatten</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span>  <span class="c1"># matplotlib.lines.Line2D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flatten</span><span class="p">([</span><span class="n">bands</span><span class="p">]))</span>  <span class="c1"># matplotlib.collections.PolyCollection(s)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;set_color&#39;</span><span class="p">,</span> <span class="s1">&#39;set_lw&#39;</span><span class="p">,</span> <span class="s1">&#39;set_linewidth&#39;</span><span class="p">,</span> <span class="s1">&#39;set_dashes&#39;</span><span class="p">,</span> <span class="s1">&#39;set_linestyle&#39;</span><span class="p">]:</span>
            <span class="k">def</span> <span class="nf">_band_line_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Call the same method for line and band.</span>
<span class="sd">                Returns Line2D method call result.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands</span><span class="p">:</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

            <span class="k">return</span> <span class="k">lambda</span> <span class="n">method</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">_band_line_method</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">uband</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">},</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given arguments x,y where either or both have uncertainties, plot x,y using pyplt.plot</span>
<span class="sd">    of the nominal values and surround it with with a shaded error band using matplotlib&#39;s</span>
<span class="sd">    fill_between and/or fill_betweenx.</span>

<span class="sd">    If y or x is more than 1D, it is flattened along every dimension but the last.</span>

<span class="sd">    :param x: array of independent axis values</span>

<span class="sd">    :param y: array of values with uncertainties, for which shaded error band is plotted</span>

<span class="sd">    :param ax: axes instance into which to plot (default: gca())</span>

<span class="sd">    :param fill_kw: dict. Passed to pyplot.fill_between</span>

<span class="sd">    :param \**kw: Passed to pyplot.plot</span>

<span class="sd">    :return: list. A list of Uband objects containing the line and bands of each (x,y) along the last dimension.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="c1"># enable combinations of 1D and 2D x&#39;s and y&#39;s</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># one x for all y&#39;s</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># plot each (x,y) and collect the lines/bands into a single object</span>
    <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">xnom</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">xi</span><span class="p">)))</span>
        <span class="n">xerr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">std_devs</span><span class="p">(</span><span class="n">xi</span><span class="p">)))</span>
        <span class="n">ynom</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">yi</span><span class="p">)))</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">std_devs</span><span class="p">(</span><span class="n">yi</span><span class="p">)))</span>

        <span class="n">l</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xnom</span><span class="p">,</span> <span class="n">ynom</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="n">fkw</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fill_kw</span><span class="p">)</span>  <span class="c1"># changes to fill_kw propagate to the next call of uband!</span>
        <span class="n">fkw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">yerr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">bandy</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xnom</span><span class="p">,</span> <span class="n">ynom</span> <span class="o">-</span> <span class="n">yerr</span><span class="p">,</span> <span class="n">ynom</span> <span class="o">+</span> <span class="n">yerr</span><span class="p">,</span> <span class="o">**</span><span class="n">fkw</span><span class="p">)</span>
            <span class="n">bands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bandy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">xerr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">bandx</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">ynom</span><span class="p">,</span> <span class="n">xnom</span> <span class="o">-</span> <span class="n">xerr</span><span class="p">,</span> <span class="n">xnom</span> <span class="o">+</span> <span class="n">xerr</span><span class="p">,</span> <span class="o">**</span><span class="n">fkw</span><span class="p">)</span>
            <span class="n">bands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bandx</span><span class="p">)</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">Uband</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">bands</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<div class="viewcode-block" id="get_channel_count"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.get_channel_count">[docs]</a><span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">get_channel_count</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">hw_sys</span><span class="p">,</span> <span class="n">check_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test_checker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channels_name</span><span class="o">=</span><span class="s1">&#39;channel&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function for CX hardware overlays.</span>
<span class="sd">    Gets a channel count for some hardware systems.</span>
<span class="sd">    Provide check_loc to make sure some data exist.</span>

<span class="sd">    :param ods: OMAS ODS instance</span>

<span class="sd">    :param hw_sys: string</span>
<span class="sd">        Hardware system to check. Must be a valid top level IDS name, like &#39;thomson_scattering&#39;</span>

<span class="sd">    :param check_loc: [optional] string</span>
<span class="sd">        If provided, an additional check will be made to ensure that some data exist.</span>
<span class="sd">        If this check fails, channel count will be set to 0</span>
<span class="sd">        Example: &#39;thomson_scattering.channel.0.position.r&#39;</span>

<span class="sd">    :param test_checker: [optional] string to evaluate into bool</span>
<span class="sd">        Like &quot;checker &gt; 0&quot;, where checker = ods[check_loc]. If this test fails, nc will be set to 0</span>

<span class="sd">    :param channels_name: string</span>
<span class="sd">        Use if you need to generalize to something that doesn&#39;t have real channels but has something analogous,</span>
<span class="sd">        like how &#39;gas_injection&#39; has &#39;pipe&#39; that&#39;s shaped like &#39;channel&#39; is in &#39;thomson_scattering&#39;.</span>

<span class="sd">    :return: Number of channels for this hardware system. 0 indicates empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="n">hw_sys</span><span class="p">][</span><span class="n">channels_name</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">check_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">checker</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="n">check_loc</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">test_checker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">eval</span><span class="p">(</span><span class="n">test_checker</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">printd</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> overlay could not find sufficient data to make a plot&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hw_sys</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nc</span></div>


<span class="k">def</span> <span class="nf">gas_filter</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">which_gas</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility: processes the mask / which_gas selector for gas_injection_overlay</span>
<span class="sd">    :param label: string</span>
<span class="sd">        Label for a gas valve to be tested</span>

<span class="sd">    :param which_gas: string or list</span>
<span class="sd">        See gas_injection_overlay docstring</span>

<span class="sd">    :return: bool</span>
<span class="sd">        Flag indicating whether or not a valve with this label should be shown</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">include</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_gas</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">which_gas</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">include</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_gas</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">include</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">wg</span> <span class="ow">in</span> <span class="n">label</span> <span class="k">for</span> <span class="n">wg</span> <span class="ow">in</span> <span class="n">which_gas</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">include</span>


<span class="k">def</span> <span class="nf">gas_arrow</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">snap_to</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draws an arrow pointing in from the gas valve</span>
<span class="sd">    :param ods: ODS instance</span>

<span class="sd">    :param r: float</span>
<span class="sd">        R position of gas injector (m)</span>

<span class="sd">    :param z: float</span>
<span class="sd">        Z position of gas injector (m)</span>

<span class="sd">    :param direction: float</span>
<span class="sd">        Direction of injection (radians, COCOS should match ods.cocos). None = try to guess.</span>

<span class="sd">    :param snap_to: float</span>
<span class="sd">        Snap direction angle to nearest value. Set snap to pi/4 to snap to 0, pi/4, pi/2, 3pi/4, etc. No in-between.</span>

<span class="sd">    :param ax: axes instance into which to plot (default: gca())</span>

<span class="sd">    :param color: matplotlib color specification</span>

<span class="sd">    :param pad: float</span>
<span class="sd">        Padding between arrow tip and specified (r,z)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="k">def</span> <span class="nf">pick_direction</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Guesses the direction for the arrow (from injector toward machine) in case you don&#39;t know&quot;&quot;&quot;</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;global_quantities&#39;</span><span class="p">][</span><span class="s1">&#39;magnetic_axis&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;global_quantities&#39;</span><span class="p">][</span><span class="s1">&#39;magnetic_axis&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dz</span><span class="p">,</span> <span class="o">-</span><span class="n">dr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">snap_to</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">snap_to</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">theta</span> <span class="o">/</span> <span class="n">snap_to</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">theta</span>

    <span class="k">if</span> <span class="n">direction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">pick_direction</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">cocos_transform</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">cocos</span><span class="p">,</span> <span class="mi">11</span><span class="p">)[</span><span class="s1">&#39;BP&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">shaft_len</span> <span class="o">=</span> <span class="mf">3.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">pad</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="n">da</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">10</span>  <span class="c1"># Angular half width of the arrow head</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span><span class="p">)</span> <span class="o">*</span> <span class="n">pad</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span><span class="p">)</span> <span class="o">*</span> <span class="n">pad</span>
    <span class="n">head_mark</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span>
        <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span> <span class="o">+</span> <span class="n">da</span><span class="p">),</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span> <span class="o">+</span> <span class="n">da</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span><span class="p">),</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">shaft_len</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span><span class="p">),</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">shaft_len</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span><span class="p">),</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span> <span class="o">-</span> <span class="n">da</span><span class="p">),</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">direction</span> <span class="o">-</span> <span class="n">da</span><span class="p">)),</span>
    <span class="p">]</span>

    <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Ignore this</span>
    <span class="k">return</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">head_mark</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">pad</span> <span class="o">+</span> <span class="n">shaft_len</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">geo_type_lookup</span><span class="p">(</span><span class="n">geometry_type</span><span class="p">,</span> <span class="n">subsys</span><span class="p">,</span> <span class="n">imas_version</span><span class="o">=</span><span class="n">omas_rcparams</span><span class="p">[</span><span class="s1">&#39;default_imas_version&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a geometry type code</span>

<span class="sd">    :param geometry_type: int (or string if reverse=True)</span>
<span class="sd">        Geometry type code (or geometry name if reverse)</span>

<span class="sd">    :param subsys: string</span>
<span class="sd">        Name of subsystem or ODS, like &#39;pf_active&#39;</span>

<span class="sd">    :param imas_version: string</span>
<span class="sd">        IMAS version to use when mapping</span>

<span class="sd">    :param reverse: bool</span>
<span class="sd">        Switches the roles of param geometry_type and return</span>

<span class="sd">    :return: string (or int if reverse=True)</span>
<span class="sd">        Name of the field indicated by geometry_type (or type code if reverse=True).</span>
<span class="sd">        For example: In IMAS 3.19.0, `pf_active.coil[:].element[:].geometry.geometry_type = 1` means &#39;outline&#39;.</span>
<span class="sd">        In version 3.19.0 the following geometry types exist {1: &#39;outline&#39;, 2: &#39;rectangle&#39;, 4: &#39;arcs of circle&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Fetch information from IMAS data description of geometry_type for the relevant subsys</span>
    <span class="n">lookup</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ic_antennas&#39;</span><span class="p">:</span> <span class="s1">&#39;ic_antennas.antenna.:.strap.:.geometry.geometry_type&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pf_active&#39;</span><span class="p">:</span> <span class="s1">&#39;pf_active.coil.:.element.:.geometry.geometry_type&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">subsys</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">printe</span><span class="p">(</span><span class="s1">&#39;Warning: unrecognized IMAS substructure (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subsys</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">omas_info_node</span><span class="p">(</span><span class="n">lookup</span><span class="p">[</span><span class="n">subsys</span><span class="p">],</span> <span class="n">imas_version</span><span class="o">=</span><span class="n">imas_version</span><span class="p">)[</span><span class="s1">&#39;documentation&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
        <span class="n">printe</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">_excp</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">geo_map</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">doc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="mi">3</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geo_map</span><span class="p">:</span>
        <span class="n">geo_map</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;oblique&#39;</span>  <span class="c1"># For backward compatibility</span>

    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
        <span class="c1"># https://stackoverflow.com/a/13149770/6605826</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">geo_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="nb">list</span><span class="p">(</span><span class="n">geo_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">geometry_type</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">geo_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">geometry_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="c1"># ================================</span>
<span class="c1"># ODSs&#39; plotting methods</span>
<span class="c1"># ================================</span>
<div class="viewcode-block" id="equilibrium_CX"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.equilibrium_CX">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">equilibrium_CX</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot equilibrium cross-section</span>
<span class="sd">    as per `ods[&#39;equilibrium&#39;][&#39;time_slice&#39;][time_index]`</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time slice to plot</span>

<span class="sd">    :param levels: list of sorted numeric values to pass to 2D plot as contour levels</span>

<span class="sd">    :param ax: axes to plot in (active axes is generated if `ax is None`)</span>

<span class="sd">    :param kw: arguments passed to matplotlib plot statements</span>

<span class="sd">    :return: axes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">wall</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eq</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;wall&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall&#39;</span><span class="p">][</span><span class="s1">&#39;description_2d&#39;</span><span class="p">]:</span>
            <span class="n">wall</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall&#39;</span><span class="p">][</span><span class="s1">&#39;description_2d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;limiter&#39;</span><span class="p">][</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall&#39;</span><span class="p">][</span><span class="s1">&#39;description_2d&#39;</span><span class="p">]:</span>
            <span class="n">wall</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall&#39;</span><span class="p">][</span><span class="s1">&#39;description_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;limiter&#39;</span><span class="p">][</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span>

    <span class="c1"># plotting style</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;linewidth&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">kw1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">kw1</span><span class="p">[</span><span class="s1">&#39;linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;linewidth&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># boundary</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="s1">&#39;boundary&#39;</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;boundary&#39;</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kw1</span><span class="p">)</span>
    <span class="n">kw1</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>

    <span class="c1"># axis</span>
    <span class="k">if</span> <span class="s1">&#39;global_quantities.magnetic_axis.r&#39;</span> <span class="ow">in</span> <span class="n">eq</span> <span class="ow">and</span> <span class="s1">&#39;global_quantities.magnetic_axis.z&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="s1">&#39;global_quantities&#39;</span><span class="p">][</span><span class="s1">&#39;magnetic_axis&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;global_quantities&#39;</span><span class="p">][</span><span class="s1">&#39;magnetic_axis&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw1</span><span class="p">)</span>

    <span class="c1"># first try to plot as function of `rho` and fallback on `psi`</span>
    <span class="k">if</span> <span class="s1">&#39;phi&#39;</span> <span class="ow">in</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;phi&#39;</span> <span class="ow">in</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]:</span>
        <span class="n">value2D</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;phi&#39;</span><span class="p">]))</span>
        <span class="n">value1D</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;phi&#39;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value2D</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;psi&#39;</span><span class="p">]</span>
        <span class="n">value1D</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;psi&#39;</span><span class="p">]</span>
    <span class="n">value2D</span> <span class="o">=</span> <span class="p">(</span><span class="n">value2D</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">value1D</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">value1D</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">value1D</span><span class="p">))</span>

    <span class="c1"># wall clipping</span>
    <span class="k">if</span> <span class="n">wall</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wall</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">wall</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]])))</span>
        <span class="n">wall_path</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">PathPatch</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">wall_path</span><span class="p">)</span>

    <span class="c1"># contours</span>
    <span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Z</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;dim2&#39;</span><span class="p">],</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;dim1&#39;</span><span class="p">])</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">,</span> <span class="n">kw1</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">])</span>
    <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;linewidths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;linewidth&#39;</span><span class="p">)</span>
    <span class="n">CS</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">value2D</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="c1"># internal flux surfaces w/ or w/o masking</span>
    <span class="k">if</span> <span class="n">wall</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">CS</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">set_clip_path</span><span class="p">(</span><span class="n">wall_path</span><span class="p">)</span>

    <span class="c1"># wall</span>
    <span class="k">if</span> <span class="n">wall</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wall</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">wall</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">wall</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">wall</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">wall</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]),</span>
                 <span class="nb">max</span><span class="p">(</span><span class="n">wall</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">])])</span>

    <span class="c1"># axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="equilibrium_summary"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.equilibrium_summary">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">equilibrium_summary</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot equilibrium cross-section and P, q, P&#39;, FF&#39; profiles</span>
<span class="sd">    as per `ods[&#39;equilibrium&#39;][&#39;time_slice&#39;][time_index]`</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time slice to plot</span>

<span class="sd">    :param fig: figure to plot in (a new figure is generated if `fig is None`)</span>

<span class="sd">    :param kw: arguments passed to matplotlib plot statements</span>

<span class="sd">    :return: figure handler</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">equilibrium_CX</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="n">time_index</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">eq</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>

    <span class="c1"># x</span>
    <span class="k">if</span> <span class="s1">&#39;phi&#39;</span> <span class="ow">in</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;phi&#39;</span> <span class="ow">in</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;phi&#39;</span><span class="p">]))</span>
        <span class="n">xName</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">rho$&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;psi&#39;</span><span class="p">]</span>
        <span class="n">xName</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">psi$&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c1"># pressure</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$\,$ Pressure&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># q</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;q&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$q$ Safety factor&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
        <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span>
        <span class="k">if</span> <span class="n">compare_version</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="s1">&#39;3.1.0&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">leg</span><span class="o">.</span><span class="n">set_draggable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">leg</span><span class="o">.</span><span class="n">draggable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># dP_dpsi</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;dpressure_dpsi&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;$P\,^</span><span class="se">\\</span><span class="s2">prime$ source function&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xName</span><span class="p">)</span>

    <span class="c1"># FdF_dpsi</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">236</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;f_df_dpsi&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;$FF\,^</span><span class="se">\\</span><span class="s2">prime$ source function&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xName</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="core_profiles_summary"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.core_profiles_summary">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">core_profiles_summary</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">combine_dens_temps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_thermal_fast_breakdown</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_total_density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot densities and temperature profiles for electrons and all ion species</span>
<span class="sd">    as per `ods[&#39;core_profiles&#39;][&#39;profiles_1d&#39;][time_index]`</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time slice to plot</span>

<span class="sd">    :param fig: figure to plot in (a new figure is generated if `fig is None`)</span>

<span class="sd">    :param combine_dens_temps: combine species plot of density and temperatures</span>

<span class="sd">    :param show_thermal_fast_breakdown: bool</span>
<span class="sd">        Show thermal and fast components of density in addition to total if available</span>

<span class="sd">    :param show_total_density: bool</span>
<span class="sd">        Show total thermal+fast in addition to thermal/fast breakdown if available</span>

<span class="sd">    :param kw: arguments passed to matplotlib plot statements</span>

<span class="sd">    :return: figure handler</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">prof1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;grid.rho_tor_norm&#39;</span><span class="p">]</span>

    <span class="n">what</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ion[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]))]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Electrons&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion[</span><span class="si">%d</span><span class="s1">].label&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; ion&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]))]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax0</span> <span class="o">=</span> <span class="n">ax1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">what</span><span class="p">):</span>

        <span class="c1"># densities (thermal and fast)</span>
        <span class="k">for</span> <span class="n">therm_fast</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_thermal&#39;</span><span class="p">,</span> <span class="s1">&#39;_fast&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">show_thermal_fast_breakdown</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">therm_fast</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># Skip _thermal and _fast because the flag turned these details off</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">show_total_density</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">therm_fast</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># Skip total thermal+fast because the flag turned it off</span>
            <span class="n">therm_fast_name</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="s1">&#39; (thermal+fast)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;_thermal&#39;</span><span class="p">:</span> <span class="s1">&#39; (thermal)&#39;</span> <span class="k">if</span> <span class="n">show_total_density</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;_fast&#39;</span><span class="p">:</span> <span class="s1">&#39; (fast)&#39;</span><span class="p">,</span>
            <span class="p">}[</span><span class="n">therm_fast</span><span class="p">]</span>
            <span class="n">density</span> <span class="o">=</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;.density&#39;</span> <span class="o">+</span> <span class="n">therm_fast</span>
            <span class="c1"># generate axes</span>
            <span class="k">if</span> <span class="n">combine_dens_temps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="c1"># plot if data is present</span>
            <span class="k">if</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;.density&#39;</span> <span class="o">+</span> <span class="n">therm_fast</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">:</span>
                <span class="n">uband</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">prof1d</span><span class="p">[</span><span class="n">density</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">therm_fast_name</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]):</span>
                    <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">rho$&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">combine_dens_temps</span><span class="p">:</span>
                        <span class="n">leg</span> <span class="o">=</span> <span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="kn">import</span> <span class="nn">matplotlib</span>
                        <span class="k">if</span> <span class="n">compare_version</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="s1">&#39;3.1.0&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">leg</span><span class="o">.</span><span class="n">set_draggable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">leg</span><span class="o">.</span><span class="n">draggable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Density [m$^{-3}$]&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">combine_dens_temps</span><span class="p">:</span>
                    <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="c1"># add plot of measurements</span>
            <span class="k">if</span> <span class="n">density</span> <span class="o">+</span> <span class="s1">&#39;_fit.measured&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span> <span class="ow">and</span> <span class="n">density</span> <span class="o">+</span> <span class="s1">&#39;_fit.rho_tor_norm&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">:</span>
                <span class="n">uerrorbar</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="n">density</span> <span class="o">+</span> <span class="s1">&#39;_fit.rho_tor_norm&#39;</span><span class="p">],</span> <span class="n">prof1d</span><span class="p">[</span><span class="n">density</span> <span class="o">+</span> <span class="s1">&#39;_fit.measured&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># temperatures</span>
        <span class="k">if</span> <span class="n">combine_dens_temps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="c1"># plot if data is present</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;.temperature&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">:</span>
            <span class="n">uband</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">prof1d</span><span class="p">[</span><span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;.temperature&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]):</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">rho$&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Temperature [eV]&#39;</span><span class="p">)</span>
            <span class="c1"># add plot of measurements</span>
            <span class="k">if</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;.temperature_fit.measured&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;.temperature_fit.rho_tor_norm&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">:</span>
                <span class="n">uerrorbar</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;.temperature_fit.rho_tor_norm&#39;</span><span class="p">],</span> <span class="n">prof1d</span><span class="p">[</span><span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;.temperature_fit.measured&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ax0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax0</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">if</span> <span class="n">ax1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="core_profiles_pressures"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.core_profiles_pressures">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">core_profiles_pressures</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot pressures in `ods[&#39;core_profiles&#39;][&#39;profiles_1d&#39;][time_index]`</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time slice to plot</span>

<span class="sd">    :param ax: axes to plot in (active axes is generated if `ax is None`)</span>

<span class="sd">    :param kw: arguments passed to matplotlib plot statements</span>

<span class="sd">    :return: axes handler</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">prof1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;grid.rho_tor_norm&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="o">.</span><span class="n">paths</span><span class="p">():</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">l2o</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;pressure&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;ion&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;ion.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">elif</span> <span class="s1">&#39;electrons&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;e$^-$&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="n">label</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39; (thermal)&#39;</span> <span class="k">if</span> <span class="s1">&#39;thermal&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39; (fast)&#39;</span> <span class="k">if</span> <span class="s1">&#39;fast&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">uband</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">prof1d</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure (Pa)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">rho_N$&#39;</span><span class="p">)</span>
    <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="k">if</span> <span class="n">compare_version</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="s1">&#39;3.1.0&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">leg</span><span class="o">.</span><span class="n">set_draggable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">leg</span><span class="o">.</span><span class="n">draggable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>


<span class="c1"># ================================</span>
<span class="c1"># Hardware overlays</span>
<span class="c1"># ================================</span>
<div class="viewcode-block" id="overlay"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.overlay">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">overlay</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_autoscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_all_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots overlays of hardware/diagnostic locations on a tokamak cross section plot</span>

<span class="sd">    :param ods: OMAS ODS instance</span>

<span class="sd">    :param ax: axes instance into which to plot (default: gca())</span>

<span class="sd">    :param allow_autoscale: bool</span>
<span class="sd">        Certain overlays will be allowed to unlock xlim and ylim, assuming that they have been locked by equilibrium_CX.</span>
<span class="sd">        If this option is disabled, then hardware systems like PF-coils will be off the plot and mostly invisible.</span>

<span class="sd">    :param debug_all_plots: bool</span>
<span class="sd">        Individual hardware systems are on by default instead of off by default.</span>

<span class="sd">    :param \**kw: additional keywords for selecting plots.</span>

<span class="sd">        - Select plots by setting their names to True; e.g.: if you want the gas_injection plot, set gas_injection=True</span>
<span class="sd">          as a keyword.</span>
<span class="sd">          If debug_all_plots is True, then you can turn off individual plots by, for example, set_gas_injection=False.</span>

<span class="sd">        - Instead of True to simply turn on an overlay, you can pass a dict of keywords to pass to a particular overlay</span>
<span class="sd">          method, as in thomson={&#39;labelevery&#39;: 5}. After an overlay pops off its keywords, remaining keywords are passed</span>
<span class="sd">          to plot, so you can set linestyle, color, etc.</span>

<span class="sd">        - Overlay functions accept these standard keywords:</span>
<span class="sd">            * mask: bool array</span>
<span class="sd">                Set of flags for switching plot elements on/off. Must be equal to the number of channels or items to be</span>
<span class="sd">                plotted.</span>

<span class="sd">            * labelevery: int</span>
<span class="sd">                Sets how often to add labels to the plot. A setting of 0 disables labels, 1 labels every element,</span>
<span class="sd">                2 labels every other element, 3 labels every third element, etc.</span>

<span class="sd">            * notesize: matplotlib font size specification</span>
<span class="sd">                Applies to annotations drawn on the plot. Examples: &#39;xx-small&#39;, &#39;medium&#39;, 16</span>

<span class="sd">            * Additional keywords are passed to the function that does the drawing; usually matplotlib.axes.Axes.plot().</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">overlay_on_by_default</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;thomson_scattering&#39;</span><span class="p">]</span>  <span class="c1"># List of strings describing default hardware to be shown</span>
    <span class="k">for</span> <span class="n">hw_sys</span> <span class="ow">in</span> <span class="n">list_structures</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">imas_version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hw_sys</span><span class="p">,</span> <span class="p">((</span><span class="n">hw_sys</span> <span class="ow">in</span> <span class="n">overlay_on_by_default</span><span class="p">)</span> <span class="ow">or</span> <span class="n">debug_all_plots</span><span class="p">)):</span>
            <span class="n">overlay_kw</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hw_sys</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hw_sys</span><span class="p">,</span> <span class="p">{}),</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">overlay_function</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_overlay&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hw_sys</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">allow_autoscale</span> <span class="ow">and</span> <span class="n">hw_sys</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pf_active&#39;</span><span class="p">,</span> <span class="s1">&#39;gas_injection&#39;</span><span class="p">]:</span>  <span class="c1"># Not all systems need expanded range to fit everything</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">overlay_function</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">overlay_kw</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="gas_injection_overlay"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.gas_injection_overlay">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">gas_injection_overlay</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">angle_not_in_pipe_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">which_gas</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                          <span class="n">simple_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_spacer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draw_arrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots overlays of gas injectors</span>

<span class="sd">    :param ods: OMAS ODS instance</span>

<span class="sd">    :param ax: axes instance into which to plot (default: gca())</span>

<span class="sd">    :param angle_not_in_pipe_name: bool</span>
<span class="sd">        Set this to include (Angle) at the end of injector labels. Useful if injector/pipe names don&#39;t already include</span>
<span class="sd">        angles in them.</span>

<span class="sd">    :param which_gas: string or list</span>
<span class="sd">        Filter for selecting which gas valves to display.</span>

<span class="sd">        - If string: get a preset group, like &#39;all&#39;.</span>

<span class="sd">        - If list: only valves in the list will be shown. Abbreviations are tolerated; e.g. GASA is recognized as</span>
<span class="sd">          GASA_300. One abbreviation can turn on several valves. There are several valve names starting with</span>
<span class="sd">          RF_ on DIII-D, for example.</span>

<span class="sd">    :param simple_labels: bool</span>
<span class="sd">        Simplify labels by removing suffix after the last underscore.</span>

<span class="sd">    :param label_spacer: int</span>
<span class="sd">        Number of blank lines and spaces to insert between labels and symbol</span>

<span class="sd">    :param colors: list of matplotlib color specifications.</span>
<span class="sd">        These colors control the display of various gas ports. The list will be repeated to make sure it is long enough.</span>
<span class="sd">        Do not specify a single RGB tuple by itself. However, a single tuple inside list is okay [(0.9, 0, 0, 0.9)].</span>
<span class="sd">        If the color keyword is used (See \**kw), then color will be popped to set the default for colors in case colors</span>
<span class="sd">        is None.</span>

<span class="sd">    :param draw_arrow: bool or dict</span>
<span class="sd">        Draw an arrow toward the machine at the location of the gas valve. If dict, pass keywords to arrow drawing func.</span>

<span class="sd">    :param \**kw: Additional keywords for gas plot:</span>

<span class="sd">        * Accepts standard omas_plot overlay keywords: mask, labelevery, notesize</span>

<span class="sd">        * Remaining keywords are passed to plot call for drawing markers at the gas locations.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="c1"># Make sure there is something to plot or else just give up and return</span>
    <span class="n">npipes</span> <span class="o">=</span> <span class="n">get_channel_count</span><span class="p">(</span>
        <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;gas_injection&#39;</span><span class="p">,</span> <span class="n">check_loc</span><span class="o">=</span><span class="s1">&#39;gas_injection.pipe.0.exit_position.r&#39;</span><span class="p">,</span> <span class="n">test_checker</span><span class="o">=</span><span class="s1">&#39;checker &gt; 0&#39;</span><span class="p">,</span>
        <span class="n">channels_name</span><span class="o">=</span><span class="s1">&#39;pipe&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">npipes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npipes</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">pipes</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;gas_injection&#39;</span><span class="p">][</span><span class="s1">&#39;pipe&#39;</span><span class="p">]</span>  <span class="c1"># Shortcut</span>

    <span class="c1"># Identify gas injectors with the same poloidal location and group them so that their labels won&#39;t overlap.</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pipes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gas_filter</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">which_gas</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># Skip this valve because it&#39;s not active</span>

            <span class="n">r</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">[</span><span class="s1">&#39;exit_position&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">pipe</span><span class="p">[</span><span class="s1">&#39;exit_position&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
            <span class="n">location_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:0.3f}</span><span class="s1">_</span><span class="si">{:0.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">simple_labels</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">locations</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">location_name</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">locations</span><span class="p">[</span><span class="n">location_name</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">label</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">angle_not_in_pipe_name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39; (</span><span class="si">{:0d}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pipe</span><span class="p">[</span><span class="s1">&#39;exit_position&#39;</span><span class="p">][</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rsplit</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;global_quantities.magnetic_axis.r&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">draw_arrow</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># This won&#39;t work without magnetic axis data, either.</span>
        <span class="n">rsplit</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">loc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">])</span>

    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;linestyle&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">labelevery</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labelevery&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">notesize</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;notesize&#39;</span><span class="p">,</span> <span class="s1">&#39;xx-small&#39;</span><span class="p">)</span>

    <span class="c1"># For each unique poloidal location, draw a marker and write a label describing all the injectors at this location.</span>
    <span class="n">default_color</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">default_color</span> <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">colors</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">colors</span> <span class="o">*=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">))))</span>  <span class="c1"># Make sure the list is long enough.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">locations</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{spacer:}</span><span class="se">\n</span><span class="si">{spacer:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="o">=</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">label_spacer</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">locations</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">draw_arrow</span><span class="p">:</span>
            <span class="n">kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">draw_arrow</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">draw_arrow</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{})</span>
            <span class="n">gas_mark</span> <span class="o">=</span> <span class="n">gas_arrow</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gas_mark</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Prevent label from being applied every time through the loop to avoid spammy legend</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">labelevery</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="n">labelevery</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">va</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">label_spacer</span> <span class="o">+</span> <span class="n">label</span> <span class="k">if</span> <span class="n">va</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span> <span class="k">else</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">label_spacer</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">gas_mark</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                    <span class="n">va</span><span class="o">=</span><span class="n">va</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">rsplit</span><span class="p">)],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">notesize</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="pf_active_overlay"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.pf_active_overlay">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">pf_active_overlay</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots overlays of active PF coils.</span>
<span class="sd">    INCOMPLETE: only the oblique geometry definition is treated so far. More should be added later.</span>

<span class="sd">    :param ods: OMAS ODS instance</span>

<span class="sd">    :param ax: axes instance into which to plot (default: gca())</span>

<span class="sd">    :param \**kw: Additional keywords</span>
<span class="sd">        scalex, scaley: passed to ax.autoscale_view() call at the end</span>

<span class="sd">        * Accepts standard omas_plot overlay keywords: mask, labelevery, notesize</span>

<span class="sd">        * Remaining keywords are passed to matplotlib.patches.Polygon call</span>
<span class="sd">            Hint: you may want to set facecolor instead of just color</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make sure there is something to plot or else just give up and return</span>

    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="n">nc</span> <span class="o">=</span> <span class="n">get_channel_count</span><span class="p">(</span>
        <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;pf_active&#39;</span><span class="p">,</span> <span class="n">check_loc</span><span class="o">=</span><span class="s1">&#39;pf_active.coil.0.element.0.geometry.geometry_type&#39;</span><span class="p">,</span> <span class="n">channels_name</span><span class="o">=</span><span class="s1">&#39;coil&#39;</span><span class="p">,</span>
        <span class="n">test_checker</span><span class="o">=</span><span class="s1">&#39;checker &gt; -1&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;Active PF coils&#39;</span><span class="p">)</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;facecolor&#39;</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
    <span class="n">labelevery</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labelevery&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">notesize</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;notesize&#39;</span><span class="p">,</span> <span class="s1">&#39;xx-small&#39;</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span>
    <span class="n">scalex</span><span class="p">,</span> <span class="n">scaley</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scalex&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scaley&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">path_rectangle</span><span class="p">(</span><span class="n">rectangle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param rectangle: ODS sub-folder: element.*.geometry.rectangle</span>
<span class="sd">        :return: n x 2 array giving the path around the outline of the coil element, suitable for input to Polygon()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">rectangle</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">rectangle</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">rectangle</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">rectangle</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">dx</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">dx</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">],</span>
            <span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="n">dy</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">dy</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">path_outline</span><span class="p">(</span><span class="n">outline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param outline: ODS sub-folder: element.*.geometry.outline</span>
<span class="sd">        :return: n x 2 array giving the path around the outline of the coil element, suitable for input to Polygon()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">outline</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">outline</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">):</span>  <span class="c1"># From  iris:/fusion/usc/src/idl/efitview/diagnoses/DIII-D/coils.pro ,  2018 June 08  D. Eldon</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">geometry_type</span> <span class="o">=</span> <span class="n">geo_type_lookup</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;pf_active.coil&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;element.0.geometry.geometry_type&#39;</span><span class="p">],</span>
                                                <span class="s1">&#39;pf_active&#39;</span><span class="p">,</span> <span class="n">ods</span><span class="o">.</span><span class="n">imas_version</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">geometry_type</span> <span class="o">=</span> <span class="s1">&#39;unrecognized&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;path_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geometry_type</span><span class="p">))(</span>
                    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;pf_active.coil&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;element.0.geometry&#39;</span><span class="p">][</span><span class="n">geometry_type</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: unrecognized geometry type for pf_active coil </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">geometry_type</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">))</span>
            <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Prevent label from being placed on more than one patch</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pf_id</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;pf_active.coil&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;element.0.identifier&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">pf_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">labelevery</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="n">labelevery</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pf_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xarr</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yarr</span><span class="p">),</span> <span class="n">pf_id</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">notesize</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Using patch collection breaks auto legend labeling, so add patches individually.</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">autoscale_view</span><span class="p">(</span><span class="n">scalex</span><span class="o">=</span><span class="n">scalex</span><span class="p">,</span> <span class="n">scaley</span><span class="o">=</span><span class="n">scaley</span><span class="p">)</span>  <span class="c1"># add_patch doesn&#39;t include this</span>

    <span class="k">return</span></div>


<span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">nbi_summary</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">gca</span><span class="p">()</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;nbi.time&#39;</span><span class="p">]</span>
    <span class="n">nbi</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;nbi.unit&#39;</span><span class="p">]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">nbi</span><span class="p">:</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nbi</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;power_launched.data&#39;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">nbi</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;identifier&#39;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Neutral Beam Injectors power&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power [W]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<div class="viewcode-block" id="magnetics_overlay"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.magnetics_overlay">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">magnetics_overlay</span><span class="p">(</span>
        <span class="n">ods</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_bpol_probe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_flux_loop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bpol_probe_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flux_loop_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bpol_probe_marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">flux_loop_marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots overlays of magnetics: B_pol probes and flux loops</span>

<span class="sd">    :param ods: OMAS ODS instance</span>

<span class="sd">    :param ax: axes instance into which to plot (default: gca())</span>

<span class="sd">    :param show_bpol_probe: bool</span>
<span class="sd">        Turn display of B_pol probes on/off</span>

<span class="sd">    :param show_flux_loop: bool</span>
<span class="sd">        Turn display of flux loops on/off</span>

<span class="sd">    :param bpol_probe_color: matplotlib color specification for B_pol probes</span>

<span class="sd">    :param flux_loop_color: matplotlib color specification for flux loops</span>

<span class="sd">    :param bpol_probe_marker: matplotlib marker specification for B_pol probes</span>

<span class="sd">    :param flux_loop_marker: matplotlib marker specification for flux loops</span>

<span class="sd">    :param \**kw: Additional keywords</span>

<span class="sd">        * Accepts standard omas_plot overlay keywords: mask, labelevery, notesize</span>

<span class="sd">        * Remaining keywords are passed to plot call</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="c1"># Make sure there is something to plot or else just give up and return</span>
    <span class="n">nbp</span> <span class="o">=</span> <span class="n">get_channel_count</span><span class="p">(</span>
        <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;magnetics&#39;</span><span class="p">,</span> <span class="n">check_loc</span><span class="o">=</span><span class="s1">&#39;magnetics.b_field_pol_probe.0.position.r&#39;</span><span class="p">,</span> <span class="n">channels_name</span><span class="o">=</span><span class="s1">&#39;b_field_pol_probe&#39;</span><span class="p">,</span>
        <span class="n">test_checker</span><span class="o">=</span><span class="s1">&#39;checker &gt; 0&#39;</span><span class="p">)</span>
    <span class="n">nfl</span> <span class="o">=</span> <span class="n">get_channel_count</span><span class="p">(</span>
        <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;magnetics&#39;</span><span class="p">,</span> <span class="n">check_loc</span><span class="o">=</span><span class="s1">&#39;magnetics.flux_loop.0.position.0.r&#39;</span><span class="p">,</span> <span class="n">channels_name</span><span class="o">=</span><span class="s1">&#39;flux_loop&#39;</span><span class="p">,</span>
        <span class="n">test_checker</span><span class="o">=</span><span class="s1">&#39;checker &gt; 0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">([</span><span class="n">nbp</span><span class="p">,</span> <span class="n">nfl</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">color</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">bpol_probe_color</span> <span class="o">=</span> <span class="n">color</span> <span class="k">if</span> <span class="n">bpol_probe_color</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bpol_probe_color</span>
    <span class="n">flux_loop_color</span> <span class="o">=</span> <span class="n">color</span> <span class="k">if</span> <span class="n">flux_loop_color</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">flux_loop_color</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;linestyle&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">labelevery</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labelevery&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nbp</span> <span class="o">+</span> <span class="n">nfl</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span>
    <span class="n">notesize</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;notesize&#39;</span><span class="p">,</span> <span class="s1">&#39;xx-small&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_mag</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">topname</span><span class="p">,</span> <span class="n">posroot</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color_</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">mask_</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="n">topname</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">posroot</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="n">topname</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">posroot</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">mask_</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">mask_</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">color_</span> <span class="o">=</span> <span class="n">mark</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>  <span class="c1"># If this was None before, the cycler will have given us something. Lock it in.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">mask_</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">labelevery</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="n">labelevery</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">mask_</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">mask_</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">ods</span><span class="p">[</span><span class="n">topname</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;identifier&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">notesize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_bpol_probe</span><span class="p">:</span>
        <span class="n">show_mag</span><span class="p">(</span>
            <span class="n">nbp</span><span class="p">,</span> <span class="s1">&#39;magnetics.b_field_pol_probe&#39;</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;$B_</span><span class="si">{pol}</span><span class="s1">$ probes&#39;</span><span class="p">,</span> <span class="n">bpol_probe_color</span><span class="p">,</span> <span class="n">bpol_probe_marker</span><span class="p">,</span>
            <span class="n">mask</span><span class="p">[:</span><span class="n">nbp</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">show_flux_loop</span><span class="p">:</span>
        <span class="n">show_mag</span><span class="p">(</span><span class="n">nfl</span><span class="p">,</span> <span class="s1">&#39;magnetics.flux_loop&#39;</span><span class="p">,</span> <span class="s1">&#39;position.0&#39;</span><span class="p">,</span> <span class="s1">&#39;Flux loops&#39;</span><span class="p">,</span> <span class="n">flux_loop_color</span><span class="p">,</span> <span class="n">flux_loop_marker</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="n">nbp</span><span class="p">:])</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="interferometer_overlay"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.interferometer_overlay">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">interferometer_overlay</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots overlays of interferometer chords.</span>

<span class="sd">    :param ods: OMAS ODS instance</span>

<span class="sd">    :param ax: axes instance into which to plot (default: gca())</span>

<span class="sd">    :param \**kw: Additional keywords</span>

<span class="sd">        * Accepts standard omas_plot overlay keywords: mask, labelevery, notesize</span>

<span class="sd">        * Remaining keywords are passed to plot call</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="c1"># Make sure there is something to plot or else just give up and return</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="n">get_channel_count</span><span class="p">(</span>
        <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;interferometer&#39;</span><span class="p">,</span> <span class="n">check_loc</span><span class="o">=</span><span class="s1">&#39;interferometer.channel.0.line_of_sight.first_point.r&#39;</span><span class="p">,</span>
        <span class="n">test_checker</span><span class="o">=</span><span class="s1">&#39;checker &gt; 0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">color</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">labelevery</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labelevery&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span>
    <span class="n">notesize</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;notesize&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer.channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">los</span> <span class="o">=</span> <span class="n">ch</span><span class="p">[</span><span class="s1">&#39;line_of_sight&#39;</span><span class="p">]</span>
            <span class="n">r1</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">los</span><span class="p">[</span><span class="s1">&#39;first_point.r&#39;</span><span class="p">],</span> <span class="n">los</span><span class="p">[</span><span class="s1">&#39;first_point.z&#39;</span><span class="p">],</span> <span class="n">los</span><span class="p">[</span><span class="s1">&#39;second_point.r&#39;</span><span class="p">],</span> <span class="n">los</span><span class="p">[</span><span class="s1">&#39;second_point.z&#39;</span><span class="p">]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">],</span> <span class="p">[</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;interferometer&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>  <span class="c1"># If this was None before, the cycler will have given us something. Lock it in.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">labelevery</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="n">labelevery</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="nb">max</span><span class="p">([</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">]),</span> <span class="nb">min</span><span class="p">([</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">]),</span> <span class="n">ch</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">notesize</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="thomson_scattering_overlay"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.thomson_scattering_overlay">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">thomson_scattering_overlay</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overlays Thomson channel locations</span>

<span class="sd">    :param ods: OMAS ODS instance</span>

<span class="sd">    :param ax: axes instance into which to plot (default: gca())</span>

<span class="sd">    :param \**kw: Additional keywords for Thomson plot:</span>

<span class="sd">        * Accepts standard omas_plot overlay keywords: mask, labelevery, notesize</span>

<span class="sd">        * Remaining keywords are passed to plot call</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="c1"># Make sure there is something to plot or else just give up and return</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="n">get_channel_count</span><span class="p">(</span>
        <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;thomson_scattering&#39;</span><span class="p">,</span> <span class="n">check_loc</span><span class="o">=</span><span class="s1">&#39;thomson_scattering.channel.0.position.r&#39;</span><span class="p">,</span> <span class="n">test_checker</span><span class="o">=</span><span class="s1">&#39;checker &gt; 0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">labelevery</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labelevery&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">notesize</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;notesize&#39;</span><span class="p">,</span> <span class="s1">&#39;xx-small&#39;</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;Thomson scattering&#39;</span><span class="p">)</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;linestyle&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;thomson_scattering&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)])[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;thomson_scattering&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)])[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">ts_id</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;thomson_scattering&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)])[</span><span class="n">mask</span><span class="p">]</span>

    <span class="n">ts_mark</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">labelevery</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="n">labelevery</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ts_id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">ts_mark</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">notesize</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="charge_exchange_overlay"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.charge_exchange_overlay">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">charge_exchange_overlay</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">which_pos</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overlays Charge Exchange Recombination (CER) spectroscopy channel locations</span>

<span class="sd">    :param ods: OMAS ODS instance</span>

<span class="sd">    :param ax: axes instance into which to plot (default: gca())</span>

<span class="sd">    :param which_pos: string</span>
<span class="sd">        &#39;all&#39;: plot all valid positions this channel uses. This can vary in time depending on which beams are on.</span>

<span class="sd">        &#39;closest&#39;: for each channel, pick the time slice with valid data closest to the time used for the</span>
<span class="sd">            equilibrium contours and show position at this time. Falls back to all if equilibrium time cannot be</span>
<span class="sd">            read from time_slice 0 of equilibrium in the ODS.</span>

<span class="sd">    :param \**kw: Additional keywords for CER plot:</span>

<span class="sd">        color_tangential: color to use for tangentially-viewing channels</span>

<span class="sd">        color_vertical: color to use for vertically-viewing channels</span>

<span class="sd">        color_radial: color to use for radially-viewing channels</span>

<span class="sd">        marker_tangential, marker_vertical, marker_radial: plot symbols to use for T, V, R viewing channels</span>

<span class="sd">        * Accepts standard omas_plot overlay keywords: mask, labelevery, notesize</span>

<span class="sd">        * Remaining keywords are passed to plot call</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="c1"># Make sure there is something to plot or else just give up and return</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="n">get_channel_count</span><span class="p">(</span>
        <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;charge_exchange&#39;</span><span class="p">,</span> <span class="n">check_loc</span><span class="o">=</span><span class="s1">&#39;charge_exchange.channel.0.position.r.data&#39;</span><span class="p">,</span> <span class="n">test_checker</span><span class="o">=</span><span class="s1">&#39;any(checker &gt; 0)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">eq_time</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice.0.time&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">eq_time</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Resolve keywords</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span>
    <span class="n">labelevery</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labelevery&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eq_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">which_pos</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">colorkw</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;color_tangential&#39;</span><span class="p">,</span> <span class="s1">&#39;color_vertical&#39;</span><span class="p">,</span> <span class="s1">&#39;color_radial&#39;</span><span class="p">]:</span>
        <span class="n">ckw</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">colorkw</span><span class="p">,</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ckw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colors</span><span class="p">[</span><span class="n">colorkw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">ckw</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">markers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;marker_tangential&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="n">marker</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">marker</span><span class="p">),</span>
        <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;marker_vertical&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span> <span class="k">if</span> <span class="n">marker</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">marker</span><span class="p">),</span>
        <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;marker_radial&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">marker</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">marker</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">notesize</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;notesize&#39;</span><span class="p">,</span> <span class="s1">&#39;xx-small&#39;</span><span class="p">)</span>

    <span class="c1"># Get channel positions; each channel has a list of positions as it can vary with time as beams switch on/off.</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[[</span><span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span><span class="p">]]</span> <span class="o">*</span> <span class="n">nc</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">[[</span><span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span><span class="p">]]</span> <span class="o">*</span> <span class="n">nc</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">):</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;charge_exchange.channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;position.r.data&#39;</span><span class="p">]</span>
        <span class="n">zs</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;charge_exchange.channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;position.z.data&#39;</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">rs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">zs</span><span class="p">))</span>  <span class="c1"># Validity mask: remove zero and NaN</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;charge_exchange.channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;position.r.time&#39;</span><span class="p">][</span><span class="n">w</span><span class="p">]</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
        <span class="n">zs</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">which_pos</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>  <span class="c1"># Show the set of all valid positions measured by this channel.</span>
            <span class="n">rz</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">zs</span><span class="p">)))</span>
            <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rz</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rz</span><span class="p">))]</span>
            <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rz</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rz</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># &#39;closest&#39;: pick just the closest time. The list of positions will only have one element.</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">closest_index</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">eq_time</span><span class="p">)</span>
            <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rs</span><span class="p">[</span><span class="n">w</span><span class="p">]]</span>
            <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">zs</span><span class="p">[</span><span class="n">w</span><span class="p">]]</span>
    <span class="n">cer_id</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;charge_exchange.channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)])</span>

    <span class="c1"># Plot</span>
    <span class="n">label_bank</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;Tang. CER&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="s1">&#39;Vert. CER&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;Rad. CER&#39;</span><span class="p">}</span>  <span class="c1"># These get popped so only one each in legend</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">ch_type</span> <span class="o">=</span> <span class="n">cer_id</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># See if a color has been specified for this view direction</span>
            <span class="n">cer_mark</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">markers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch_type</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                               <span class="n">label</span><span class="o">=</span><span class="n">label_bank</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ch_type</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">colors</span><span class="p">[</span><span class="n">ch_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cer_mark</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>  <span class="c1"># Save color for this view dir in case it was None</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">labelevery</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="n">labelevery</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cer_id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">notesize</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="bolometer_overlay"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.bolometer_overlay">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">bolometer_overlay</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reset_fan_color</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overlays bolometer chords</span>

<span class="sd">    :param ods: ODS instance</span>

<span class="sd">    :param ax: axes instance into which to plot (default: gca())</span>

<span class="sd">    :param reset_fan_color: bool</span>
<span class="sd">        At the start of each bolometer fan (group of channels), set color to None to let a new one be picked by the</span>
<span class="sd">        cycler. This will override manually specified color.</span>

<span class="sd">    :param colors: list of matplotlib color specifications. Do not use a single RGBA style spec.</span>

<span class="sd">    :param \**kw: Additional keywords for bolometer plot</span>

<span class="sd">        * Accepts standard omas_plot overlay keywords: mask, labelevery, notesize</span>

<span class="sd">        * Remaining keywords are passed to plot call for drawing markers at the gas locations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="c1"># Make sure there is something to plot or else just give up and return</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="n">get_channel_count</span><span class="p">(</span>
        <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;bolometer&#39;</span><span class="p">,</span> <span class="n">check_loc</span><span class="o">=</span><span class="s1">&#39;bolometer.channel.0.line_of_sight.first_point.r&#39;</span><span class="p">,</span> <span class="n">test_checker</span><span class="o">=</span><span class="s1">&#39;checker &gt; 0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;bolometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;line_of_sight.first_point.r&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)])[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;bolometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;line_of_sight.first_point.z&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)])[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;bolometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;line_of_sight.second_point.r&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)])[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;bolometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;line_of_sight.second_point.z&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)])[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">bolo_id</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;bolometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)])[</span><span class="n">mask</span><span class="p">]</span>

    <span class="n">ncm</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">nc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">*=</span> <span class="n">nc</span>  <span class="c1"># Just make sure that this will always be long enough.</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span>
    <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
    <span class="n">default_label</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">labelevery</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labelevery&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">notesize</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;notesize&#39;</span><span class="p">,</span> <span class="s1">&#39;xx-small&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncm</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">bolo_id</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">bolo_id</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">reset_fan_color</span><span class="p">:</span>
            <span class="n">ci</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span>  <span class="c1"># Allow color to reset when changing fans</span>
            <span class="n">new_label</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_label</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Bolometers </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bolo_id</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">default_label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_label</span>
        <span class="n">bolo_line</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">r1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">z1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z2</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">new_label</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">bolo_line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>  <span class="c1"># Make subsequent lines the same color</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">labelevery</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="n">labelevery</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">z1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">bolo_id</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">z1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">notesize</span><span class="p">)</span></div>


<div class="viewcode-block" id="summary"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.summary">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot summary time traces. Internally makes use of plot_quantity method.</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param fig: figure to plot in (a new figure is generated if `fig is None`)</span>

<span class="sd">    :param quantity: if None plot all time-dependent global_quantities. Else a list of strings with global quantities to plot</span>

<span class="sd">    :return: figure handler</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">quantity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">quantity</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities&#39;</span><span class="p">]</span>

    <span class="c1"># two passes, one for counting number of plots the second for actual plotting</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">]:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantity</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;value&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities&#39;</span><span class="p">][</span><span class="n">q</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities&#39;</span><span class="p">][</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                    <span class="n">ods</span><span class="o">.</span><span class="n">plot_quantity</span><span class="p">(</span><span class="s1">&#39;summary.global_quantities.</span><span class="si">%s</span><span class="s1">.value&#39;</span> <span class="o">%</span> <span class="n">q</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">c</span><span class="p">))])</span>
    <span class="k">return</span> <span class="n">fig</span></div>


<span class="n">latexit</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">latexit</span><span class="p">[</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">rho$&#39;</span>
<span class="n">latexit</span><span class="p">[</span><span class="s1">&#39;zeff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;$Z_{</span><span class="se">\\</span><span class="s1">rm eff}$&#39;</span>
<span class="n">latexit</span><span class="p">[</span><span class="s1">&#39;m^-3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;$m^{-3}$&#39;</span>
<span class="n">latexit</span><span class="p">[</span><span class="s1">&#39;psi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">psi$&#39;</span>


<div class="viewcode-block" id="quantity"><a class="viewcode-back" href="../../code/omas.omas_plot.html#omas.quantity">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">quantity</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
             <span class="n">yname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">yunits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xunits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">xnorm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ynorm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
             <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Provides convenient way to plot 1D quantities in ODS</span>

<span class="sd">    For example:</span>
<span class="sd">        &gt;&gt;&gt; ods.plot_quantity(&#39;@core.*elec.*dens&#39;, &#39;$n_e$&#39;, lw=2)</span>
<span class="sd">        &gt;&gt;&gt; ods.plot_quantity(&#39;@core.*ion.0.*dens.*th&#39;, &#39;$n_D$&#39;, lw=2)</span>
<span class="sd">        &gt;&gt;&gt; ods.plot_quantity(&#39;@core.*ion.1.*dens.*th&#39;, &#39;$n_C$&#39;, lw=2)</span>

<span class="sd">    :param ods: ODS instance</span>

<span class="sd">    :param key: ODS location or search pattern</span>

<span class="sd">    :param yname: name of the y quantity</span>

<span class="sd">    :param xname: name of the x quantity</span>

<span class="sd">    :param yunits: units of the y quantity</span>

<span class="sd">    :param xunits: units of the x quantity</span>

<span class="sd">    :param ylabel: plot ylabel</span>

<span class="sd">    :param xlabel: plot xlabel</span>

<span class="sd">    :param ynorm: normalization factor for y</span>

<span class="sd">    :param xnorm: normalization factor for x</span>

<span class="sd">    :param label: label for the legend</span>

<span class="sd">    :param ax: axes instance into which to plot (default: gca())</span>

<span class="sd">    :param \**kw: extra arguments are passed to the plot function</span>

<span class="sd">    :return: axes instance</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

    <span class="c1"># handle regular expressions</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">search_paths</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">xarray</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">yname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">yname</span> <span class="o">=</span> <span class="n">latexit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">xname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xname</span> <span class="o">=</span> <span class="n">latexit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">yunits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">yunits</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">yunits</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">latexit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">yunits</span><span class="p">,</span> <span class="n">yunits</span><span class="p">)</span>
    <span class="n">yunits</span> <span class="o">=</span> <span class="n">yunits</span> <span class="k">if</span> <span class="n">yunits</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;[-]&#39;</span><span class="p">,</span> <span class="s1">&#39;[None]&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">xunits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xunits</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">xunits</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">latexit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xunits</span><span class="p">,</span> <span class="n">xunits</span><span class="p">)</span>
    <span class="n">xunits</span> <span class="o">=</span> <span class="n">xunits</span> <span class="k">if</span> <span class="n">xunits</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;[-]&#39;</span><span class="p">,</span> <span class="s1">&#39;[None]&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">yname</span>
    <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>

    <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">yunits</span>

    <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">xname</span><span class="p">,</span> <span class="n">xunits</span><span class="p">]))</span>

    <span class="n">uband</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">xnorm</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">ynorm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>


<span class="c1"># this test is here to prevent</span>
<span class="k">if</span> <span class="s1">&#39;matplotlib&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;pyplot&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;plt&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Do not import matplotlib at the top level of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2017-2019 O. Meneghini and collaborators.<br/>
      Last updated on Nov 19, 2019.<br/>
    </p>
  </div>
</footer>
  </body>
</html>