
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>omas.omas_physics &#8212; OMAS</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><img height=40, src="../../_static/OMAS_logo.png">
          <!-- OMAS-->
        </a>
        <!-- <span class="navbar-text navbar-version pull-left"><b></b></span> -->
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../how.html">Concept</a></li>
                <li><a href="../../auto_examples/index.html">Examples</a></li>
                <li><a href="../../install.html">Installation</a></li>
                <li><a href="../../iter.html">ITER</a></li>
                <li><a href="../../omfit.html">OMFIT</a></li>
                <li><a href="../../schema.html">Data schema</a></li>
                <li><a href="../../code.html">API</a></li>
            
            
              
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">In this page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>
           <!-- 
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
           -->
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for omas.omas_physics</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;physics-based ODS methods and utilities</span>

<span class="sd">-------</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">.omas_utils</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.omas_core</span> <span class="k">import</span> <span class="n">ODS</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">__ods__</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">add_to__ODS__</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    anything wrapped here will be available as a ODS method with name &#39;physics_&#39;+f.__name__</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">__ods__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">add_to__ALL__</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="c1"># constants class that mimics scipy.constants</span>
<span class="k">class</span> <span class="nc">constants</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">e</span> <span class="o">=</span> <span class="mf">1.6021766208e-19</span>


<div class="viewcode-block" id="core_profiles_consistent"><a class="viewcode-back" href="../../code/omas.omas_physics.html#omas.core_profiles_consistent">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">core_profiles_consistent</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_electrons_density</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calls all core_profiles consistency functions including</span>
<span class="sd">      - core_profiles_pressures</span>
<span class="sd">      - core_profiles_densities</span>
<span class="sd">      - core_profiles_zeff</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :param use_electrons_density:</span>
<span class="sd">            denominator is core_profiles.profiles_1d.:.electrons.density</span>
<span class="sd">            instead of sum Z*n_i in Z_eff calculation</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ods</span> <span class="o">=</span> <span class="n">core_profiles_pressures</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">)</span>
    <span class="n">core_profiles_densities</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">core_profiles_zeff</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_electrons_density</span><span class="o">=</span><span class="n">use_electrons_density</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ods</span></div>


<div class="viewcode-block" id="core_profiles_pressures"><a class="viewcode-back" href="../../code/omas.omas_physics.html#omas.core_profiles_pressures">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">core_profiles_pressures</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculates individual ions pressures</span>

<span class="sd">        `core_profiles.profiles_1d.:.ion.:.pressure_thermal` #Pressure (thermal) associated with random motion ~average((v-average(v))^2)</span>
<span class="sd">        `core_profiles.profiles_1d.:.ion.:.pressure`         #Pressure (thermal+non-thermal)</span>

<span class="sd">    as well as total pressures</span>

<span class="sd">        `core_profiles.profiles_1d.:.pressure_thermal`       #Thermal pressure (electrons+ions)</span>
<span class="sd">        `core_profiles.profiles_1d.:.pressure_ion_total`     #Total (sum over ion species) thermal ion pressure</span>
<span class="sd">        `core_profiles.profiles_1d.:.pressure_perpendicular` #Total perpendicular pressure (electrons+ions, thermal+non-thermal)</span>
<span class="sd">        `core_profiles.profiles_1d.:.pressure_parallel`      #Total parallel pressure (electrons+ions, thermal+non-thermal)</span>

<span class="sd">    NOTE: the fast particles ion pressures are read, not set by this function:</span>

<span class="sd">        `core_profiles.profiles_1d.:.ion.:.pressure_fast_parallel`      #Pressure (thermal) associated with random motion ~average((v-average(v))^2)</span>
<span class="sd">        `core_profiles.profiles_1d.:.ion.:.pressure_fast_perpendicular` #Pressure (thermal+non-thermal)</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ods_p</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="k">import</span> <span class="n">ODS</span>
        <span class="n">ods_p</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]:</span>
        <span class="n">prof1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="n">prof1d_p</span> <span class="o">=</span> <span class="n">ods_p</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>

        <span class="n">__zeros__</span> <span class="o">=</span> <span class="mf">0.</span> <span class="o">*</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>

        <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>
        <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_ion_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>
        <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>
        <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>

        <span class="c1"># electrons</span>
        <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>

        <span class="n">__p__</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;density_thermal&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;temperature&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]:</span>
            <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;pressure_thermal&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]:</span>
            <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">__p__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span> <span class="o">/</span> <span class="mf">3.</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span> <span class="o">/</span> <span class="mf">3.</span>

        <span class="k">if</span> <span class="s1">&#39;pressure_fast_perpendicular&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]:</span>
            <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_fast_perpendicular&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_fast_perpendicular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>

        <span class="k">if</span> <span class="s1">&#39;pressure_fast_parallel&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]:</span>
            <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_fast_parallel&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_fast_parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>

        <span class="c1"># ions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">])):</span>

            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>

            <span class="n">__p__</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;density_thermal&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;temperature&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;pressure_thermal&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">__p__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span> <span class="o">/</span> <span class="mf">3.</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span> <span class="o">/</span> <span class="mf">3.</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_ion_total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>

            <span class="k">if</span> <span class="s1">&#39;pressure_fast_perpendicular&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_fast_perpendicular&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
                    <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_fast_perpendicular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>

            <span class="k">if</span> <span class="s1">&#39;pressure_fast_parallel&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_fast_parallel&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
                    <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_fast_parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>

        <span class="c1"># extra pressure information that is not within IMAS structure is set only if consistency_check is not True</span>
        <span class="k">if</span> <span class="n">ods_p</span><span class="o">.</span><span class="n">consistency_check</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_electron_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_ion_total&#39;</span><span class="p">]</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_fast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ods_p</span></div>


<div class="viewcode-block" id="core_profiles_densities"><a class="viewcode-back" href="../../code/omas.omas_physics.html#omas.core_profiles_densities">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">core_profiles_densities</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Density, density_thermal, and density_fast for electrons and ions are filled and are self-consistent</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="k">import</span> <span class="n">ODS</span>
        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">consistent_density</span><span class="p">(</span><span class="n">loc</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;density&#39;</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>

            <span class="c1"># if there is no thermal nor fast, assume it is thermal</span>
            <span class="k">if</span> <span class="s1">&#39;density_thermal&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loc</span> <span class="ow">and</span> <span class="s1">&#39;density_fast&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>
                <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span>

            <span class="c1"># if there is no thermal calculate it</span>
            <span class="k">elif</span> <span class="s1">&#39;density_thermal&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loc</span> <span class="ow">and</span> <span class="s1">&#39;density_fast&#39;</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>
                <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density_fast&#39;</span><span class="p">]</span>

            <span class="c1"># if there is no fast calculate it</span>
            <span class="k">elif</span> <span class="s1">&#39;density_thermal&#39;</span> <span class="ow">in</span> <span class="n">loc</span> <span class="ow">and</span> <span class="s1">&#39;density_fast&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>
                <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density_fast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span>

        <span class="c1"># enforce self-consistency</span>
        <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">density</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">,</span> <span class="s1">&#39;density_fast&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">density</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>
                <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">loc</span><span class="p">[</span><span class="n">density</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loc</span><span class="p">[</span><span class="n">density</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]:</span>
        <span class="n">prof1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="n">prof1d_n</span> <span class="o">=</span> <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">prof1d_n</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>

        <span class="n">__zeros__</span> <span class="o">=</span> <span class="mf">0.</span> <span class="o">*</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>

        <span class="c1"># electrons</span>
        <span class="n">consistent_density</span><span class="p">(</span><span class="n">prof1d_n</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">])</span>

        <span class="c1"># ions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">])):</span>
            <span class="n">consistent_density</span><span class="p">(</span><span class="n">prof1d_n</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">ods_n</span></div>


<div class="viewcode-block" id="core_profiles_zeff"><a class="viewcode-back" href="../../code/omas.omas_physics.html#omas.core_profiles_zeff">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">core_profiles_zeff</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_electrons_density</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    calculates effective charge</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :param use_electrons_density:</span>
<span class="sd">            denominator core_profiles.profiles_1d.:.electrons.density</span>
<span class="sd">            instead of sum Z*n_i</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ods_z</span> <span class="o">=</span> <span class="n">core_profiles_densities</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]:</span>
        <span class="n">prof1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="n">prof1d_z</span> <span class="o">=</span> <span class="n">ods_z</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>

        <span class="n">Z2n</span> <span class="o">=</span> <span class="mf">0.</span> <span class="o">*</span> <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>
        <span class="n">Zn</span> <span class="o">=</span> <span class="mf">0.</span> <span class="o">*</span> <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">])):</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;z_n&#39;</span><span class="p">]</span>  <span class="c1"># from old ODS</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;density&#39;</span><span class="p">]</span>  <span class="c1"># from new ODS</span>
            <span class="n">Z2n</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">Z</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">Zn</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">Z</span>
            <span class="k">if</span> <span class="n">use_electrons_density</span><span class="p">:</span>
                <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;zeff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z2n</span> <span class="o">/</span> <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;density&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;zeff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z2n</span> <span class="o">/</span> <span class="n">Zn</span>
    <span class="k">return</span> <span class="n">ods_z</span></div>


<div class="viewcode-block" id="current_from_eq"><a class="viewcode-back" href="../../code/omas.omas_physics.html#omas.current_from_eq">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">current_from_eq</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function sets the currents in ods[&#39;core_profiles&#39;][&#39;profiles_1d&#39;][time_index]</span>
<span class="sd">    using ods[&#39;equilibrium&#39;][&#39;time_slice&#39;][time_index][&#39;profiles_1d&#39;][&#39;j_tor&#39;]</span>

<span class="sd">    :param ods: ODS to update in-place</span>

<span class="sd">    :param time_index: ODS time index to updated</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rho</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d.rho_tor_norm&#39;</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">%d</span><span class="s1">.grid.rho_tor_norm&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">:</span> <span class="n">rho</span><span class="p">}):</span>
        <span class="c1"># call all current ohmic to start</span>
        <span class="n">fsa_invR</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;gm9&#39;</span><span class="p">]</span>
        <span class="n">JtoR_tot</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;j_tor&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fsa_invR</span>
        <span class="k">if</span> <span class="s1">&#39;core_profiles.vacuum_toroidal_field.b0&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;b0&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;equilibrium.vacuum_toroidal_field.b0&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">R0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;b0&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
            <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R0</span>
            <span class="n">ods</span><span class="o">.</span><span class="n">set_time_array</span><span class="p">(</span><span class="s1">&#39;core_profiles.vacuum_toroidal_field.b0&#39;</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">B0</span><span class="p">)</span>

        <span class="n">JparB_tot</span> <span class="o">=</span> <span class="n">transform_current</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">JtoR</span><span class="o">=</span><span class="n">JtoR_tot</span><span class="p">,</span>
                                      <span class="n">equilibrium</span><span class="o">=</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">],</span>
                                      <span class="n">includes_bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">core_profiles_currents</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">j_total</span><span class="o">=</span><span class="n">JparB_tot</span> <span class="o">/</span> <span class="n">B0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="c1"># redo but wipe out old current components since we can&#39;t make it consistent</span>
        <span class="n">core_profiles_currents</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span>
                               <span class="n">j_actuator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">j_bootstrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">j_ohmic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">j_non_inductive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">j_total</span><span class="o">=</span><span class="n">JparB_tot</span> <span class="o">/</span> <span class="n">B0</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="core_profiles_currents"><a class="viewcode-back" href="../../code/omas.omas_physics.html#omas.core_profiles_currents">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">core_profiles_currents</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">rho_tor_norm</span><span class="p">,</span>
                           <span class="n">j_actuator</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">j_bootstrap</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                           <span class="n">j_ohmic</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">j_non_inductive</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                           <span class="n">j_total</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function sets currents in ods[&#39;core_profiles&#39;][&#39;profiles_1d&#39;][time_index]</span>

<span class="sd">    If provided currents are inconsistent with each other or ods, ods is not updated and an error is thrown.</span>

<span class="sd">    Updates integrated currents in ods[&#39;core_profiles&#39;][&#39;global_quantities&#39;]</span>
<span class="sd">    (N.B.: `equilibrium` IDS is required for evaluating j_tor and integrated currents)</span>

<span class="sd">    :param ods: ODS to update in-place</span>

<span class="sd">    :param time_index: ODS time index to updated</span>

<span class="sd">    :param rho_tor_norm:  normalized rho grid upon which each j is given</span>

<span class="sd">    For each j:</span>
<span class="sd">      - ndarray: set in ods if consistent</span>
<span class="sd">      - &#39;default&#39;: use value in ods if present, else set to None</span>
<span class="sd">      - None: try to calculate from currents; delete from ods if you can&#39;t</span>

<span class="sd">    :param j_actuator: Non-inductive, non-bootstrap current &lt;J.B&gt;/B0</span>
<span class="sd">        N.B.: used for calculating other currents and consistency, but not set in ods</span>

<span class="sd">    :param j_bootstrap: Bootstrap component of &lt;J.B&gt;/B0</span>

<span class="sd">    :param j_ohmic: Ohmic component of &lt;J.B&gt;/B0</span>

<span class="sd">    :param j_non_inductive: Non-inductive component of &lt;J.B&gt;/B0</span>
<span class="sd">        Consistency requires j_non_inductive = j_actuator + j_bootstrap, either</span>
<span class="sd">        as explicitly provided or as computed from other components.</span>

<span class="sd">    :param j_total: Total &lt;J.B&gt;/B0</span>
<span class="sd">        Consistency requires j_total = j_ohmic + j_non_inductive either as</span>
<span class="sd">        explicitly provided or as computed from other components.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="k">import</span> <span class="n">cumtrapz</span>

    <span class="n">prof1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>

    <span class="c1"># SETUP DEFAULTS</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">%d</span><span class="s1">.grid.rho_tor_norm&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">:</span> <span class="n">rho_tor_norm</span><span class="p">}):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;j_actuator&#39;</span><span class="p">,</span> <span class="s1">&#39;j_bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;j_non_inductive&#39;</span><span class="p">,</span> <span class="s1">&#39;j_ohmic&#39;</span><span class="p">,</span> <span class="s1">&#39;j_total&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">eval</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="s1">&#39;j_actuator&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="s1">&#39;j_bootstrap&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;j_non_inductive&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">)):</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_actuator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;j_non_inductive&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;j_bootstrap&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">j_actuator</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_actuator&#39;</span><span class="p">]</span>
    <span class="n">j_bootstrap</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_bootstrap&#39;</span><span class="p">]</span>
    <span class="n">j_ohmic</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_ohmic&#39;</span><span class="p">]</span>
    <span class="n">j_non_inductive</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_non_inductive&#39;</span><span class="p">]</span>
    <span class="n">j_total</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_total&#39;</span><span class="p">]</span>

    <span class="c1"># =================</span>
    <span class="c1"># UPDATE FORWARD</span>
    <span class="c1"># =================</span>

    <span class="c1"># j_non_inductive</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j_actuator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_bootstrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">j_non_inductive</span> <span class="o">=</span> <span class="n">j_actuator</span> <span class="o">+</span> <span class="n">j_bootstrap</span>

    <span class="c1"># j_total</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j_ohmic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">j_total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">j_total</span> <span class="o">=</span> <span class="n">j_ohmic</span> <span class="o">+</span> <span class="n">j_non_inductive</span>

    <span class="c1"># get some quantities we&#39;ll use below</span>
    <span class="k">if</span> <span class="s1">&#39;equilibrium.time_slice.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;core_profiles.vacuum_toroidal_field.b0&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;b0&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;equilibrium.vacuum_toroidal_field.b0&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">R0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;b0&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
            <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R0</span>
            <span class="n">ods</span><span class="o">.</span><span class="n">set_time_array</span><span class="p">(</span><span class="s1">&#39;core_profiles.vacuum_toroidal_field.b0&#39;</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">B0</span><span class="p">)</span>
        <span class="n">fsa_invR</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">rho_tor_norm</span><span class="p">,</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">],</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;gm9&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># can&#39;t do any computations with the equilibrium</span>
        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
            <span class="n">printe</span><span class="p">(</span><span class="s2">&quot;Warning: ods[&#39;equilibrium&#39;] does not exist: Can&#39;t convert between j_total and j_tor or calculate integrated currents&quot;</span><span class="p">)</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># j_tor</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">JparB_tot</span> <span class="o">=</span> <span class="n">j_total</span> <span class="o">*</span> <span class="n">B0</span>
        <span class="n">JtoR_tot</span> <span class="o">=</span> <span class="n">transform_current</span><span class="p">(</span><span class="n">rho_tor_norm</span><span class="p">,</span> <span class="n">JparB</span><span class="o">=</span><span class="n">JparB_tot</span><span class="p">,</span> <span class="n">equilibrium</span><span class="o">=</span><span class="n">eq</span><span class="p">,</span> <span class="n">includes_bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">j_tor</span> <span class="o">=</span> <span class="n">JtoR_tot</span> <span class="o">/</span> <span class="n">fsa_invR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">j_tor</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># =================</span>
    <span class="c1"># UPDATE BACKWARD</span>
    <span class="c1"># =================</span>

    <span class="k">if</span> <span class="n">j_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># j_non_inductive</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_ohmic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">j_non_inductive</span> <span class="o">=</span> <span class="n">j_total</span> <span class="o">-</span> <span class="n">j_ohmic</span>

        <span class="c1"># j_ohmic</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">j_ohmic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">j_ohmic</span> <span class="o">=</span> <span class="n">j_total</span> <span class="o">-</span> <span class="n">j_non_inductive</span>

    <span class="k">if</span> <span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># j_actuator</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j_actuator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_bootstrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">j_actuator</span> <span class="o">=</span> <span class="n">j_non_inductive</span> <span class="o">-</span> <span class="n">j_bootstrap</span>

        <span class="c1"># j_bootstrap</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j_bootstrap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_actuator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">j_bootstrap</span> <span class="o">=</span> <span class="n">j_non_inductive</span> <span class="o">-</span> <span class="n">j_actuator</span>

    <span class="c1"># ===============</span>
    <span class="c1"># CONSISTENCY?</span>
    <span class="c1"># ===============</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">j_actuator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_bootstrap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Cannot set j_actuator without j_bootstrap provided or calculable&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="c1"># j_non_inductive</span>
    <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;j_non_inductive inconsistent with j_actuator and j_bootstrap&#39;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">j_actuator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j_bootstrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))):</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">j_non_inductive</span><span class="p">,</span> <span class="n">j_actuator</span> <span class="o">+</span> <span class="n">j_bootstrap</span><span class="p">),</span> <span class="n">err</span>

    <span class="c1"># j_total</span>
    <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;j_total inconsistent with j_ohmic and j_non_inductive&#39;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">j_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">j_ohmic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))):</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">j_total</span><span class="p">,</span> <span class="n">j_ohmic</span> <span class="o">+</span> <span class="n">j_non_inductive</span><span class="p">),</span> <span class="n">err</span>

    <span class="c1"># j_tor</span>
    <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;j_tor inconsistent with j_total&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_tor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">JparB_tot</span> <span class="o">=</span> <span class="n">j_total</span> <span class="o">*</span> <span class="n">B0</span>
            <span class="n">JtoR_tot</span> <span class="o">=</span> <span class="n">transform_current</span><span class="p">(</span><span class="n">rho_tor_norm</span><span class="p">,</span> <span class="n">JparB</span><span class="o">=</span><span class="n">JparB_tot</span><span class="p">,</span> <span class="n">equilibrium</span><span class="o">=</span><span class="n">eq</span><span class="p">,</span> <span class="n">includes_bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">j_tor</span><span class="p">,</span> <span class="n">JtoR_tot</span> <span class="o">/</span> <span class="n">fsa_invR</span><span class="p">),</span> <span class="n">err</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                <span class="n">printe</span><span class="p">(</span><span class="s2">&quot;Warning: ods[&#39;equilibrium&#39;] does not exist&quot;</span><span class="p">)</span>
                <span class="n">printe</span><span class="p">(</span><span class="s2">&quot;         can&#39;t determine if &quot;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>

    <span class="c1"># =============</span>
    <span class="c1"># UPDATE ODS</span>
    <span class="c1"># =============</span>

    <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">%d</span><span class="s1">.grid.rho_tor_norm&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">:</span> <span class="n">rho_tor_norm</span><span class="p">}):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;j_bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;j_non_inductive&#39;</span><span class="p">,</span> <span class="s1">&#39;j_ohmic&#39;</span><span class="p">,</span> <span class="s1">&#39;j_total&#39;</span><span class="p">,</span> <span class="s1">&#39;j_tor&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prof1d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">prof1d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="c1"># ======================</span>
    <span class="c1"># INTEGRATED CURRENTS</span>
    <span class="c1"># ======================</span>

    <span class="k">if</span> <span class="n">eq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># can&#39;t integrate currents without the equilibrium</span>
        <span class="k">return</span>

    <span class="c1"># Calculate integrated currents</span>
    <span class="n">rho_eq</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>
    <span class="n">vp</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;dvolume_dpsi&#39;</span><span class="p">]</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;psi&#39;</span><span class="p">]</span>
    <span class="n">fsa_invR</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;gm9&#39;</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">%d</span><span class="s1">.grid.rho_tor_norm&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">:</span> <span class="n">rho_eq</span><span class="p">}):</span>

        <span class="n">currents</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;j_bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;current_bootstrap&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;j_non_inductive&#39;</span><span class="p">,</span> <span class="s1">&#39;current_non_inductive&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;j_tor&#39;</span><span class="p">,</span> <span class="s1">&#39;ip&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">Jname</span><span class="p">,</span> <span class="n">Iname</span><span class="p">,</span> <span class="n">transform</span> <span class="ow">in</span> <span class="n">currents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Jname</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">:</span>
                <span class="n">J</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="n">Jname</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">transform</span><span class="p">:</span>
                    <span class="c1"># transform &lt;J.B&gt;/B0 to &lt;Jt/R&gt;</span>
                    <span class="n">J</span> <span class="o">=</span> <span class="n">transform_current</span><span class="p">(</span><span class="n">rho_eq</span><span class="p">,</span> <span class="n">JparB</span><span class="o">=</span><span class="n">J</span> <span class="o">*</span> <span class="n">B0</span><span class="p">,</span> <span class="n">equilibrium</span><span class="o">=</span><span class="n">eq</span><span class="p">,</span> <span class="n">includes_bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># already &lt;Jt/R&gt;/&lt;1/R&gt;</span>
                    <span class="n">J</span> <span class="o">*=</span> <span class="n">fsa_invR</span>
                <span class="n">ods</span><span class="o">.</span><span class="n">set_time_array</span><span class="p">(</span><span class="s1">&#39;core_profiles.global_quantities.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Iname</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span>
                                   <span class="n">cumtrapz</span><span class="p">(</span><span class="n">vp</span> <span class="o">*</span> <span class="n">J</span><span class="p">,</span> <span class="n">psi</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
            <span class="k">elif</span> <span class="s1">&#39;core_profiles.global_quantities.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Iname</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                <span class="c1"># set current to zero if this time_index exists already</span>
                <span class="k">if</span> <span class="n">time_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles.global_quantities.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Iname</span><span class="p">]):</span>
                    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles.global_quantities.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Iname</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="wall_add"><a class="viewcode-back" href="../../code/omas.wall_add.html#omas.wall_add">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">wall_add</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">machine</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Add wall information to the ODS</span>

<span class="sd">    :param ods: ODS to update in-place</span>

<span class="sd">    :param machine: machine of which to load the wall (if None it is taken from ods[&#39;dataset_description.data_entry.machine&#39;])</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">machine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;machine&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;dataset_description.data_entry&#39;</span><span class="p">]:</span>
            <span class="n">machine</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;dataset_description.data_entry.machine&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s1">&#39;Could not figure out what machine wall to use: dataset_description.data_entry.machine is not set&#39;</span><span class="p">)</span>

    <span class="n">walls</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">walls</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RLIM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.267</span><span class="p">,</span> <span class="mf">7.283</span><span class="p">,</span> <span class="mf">7.899</span><span class="p">,</span> <span class="mf">8.306</span><span class="p">,</span> <span class="mf">8.395</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">,</span> <span class="mf">7.904</span><span class="p">,</span> <span class="mf">7.4</span><span class="p">,</span>
                              <span class="mf">6.587</span><span class="p">,</span> <span class="mf">5.753</span><span class="p">,</span> <span class="mf">4.904</span><span class="p">,</span> <span class="mf">4.311</span><span class="p">,</span> <span class="mf">4.126</span><span class="p">,</span> <span class="mf">4.076</span><span class="p">,</span> <span class="mf">4.046</span><span class="p">,</span> <span class="mf">4.046</span><span class="p">,</span>
                              <span class="mf">4.067</span><span class="p">,</span> <span class="mf">4.097</span><span class="p">,</span> <span class="mf">4.178</span><span class="p">,</span> <span class="mf">3.9579</span><span class="p">,</span> <span class="mf">4.0034</span><span class="p">,</span> <span class="mf">4.1742</span><span class="p">,</span> <span class="mf">4.3257</span><span class="p">,</span> <span class="mf">4.4408</span><span class="p">,</span>
                              <span class="mf">4.5066</span><span class="p">,</span> <span class="mf">4.5157</span><span class="p">,</span> <span class="mf">4.467</span><span class="p">,</span> <span class="mf">4.4064</span><span class="p">,</span> <span class="mf">4.4062</span><span class="p">,</span> <span class="mf">4.3773</span><span class="p">,</span> <span class="mf">4.3115</span><span class="p">,</span> <span class="mf">4.2457</span><span class="p">,</span>
                              <span class="mf">4.1799</span><span class="p">,</span> <span class="mf">4.4918</span><span class="p">,</span> <span class="mf">4.5687</span><span class="p">,</span> <span class="mf">4.6456</span><span class="p">,</span> <span class="mf">4.8215</span><span class="p">,</span> <span class="mf">4.9982</span><span class="p">,</span> <span class="mf">5.1496</span><span class="p">,</span> <span class="mf">5.2529</span><span class="p">,</span>
                              <span class="mf">5.2628</span><span class="p">,</span> <span class="mf">5.2727</span><span class="p">,</span> <span class="mf">5.565</span><span class="p">,</span> <span class="mf">5.565</span><span class="p">,</span> <span class="mf">5.565</span><span class="p">,</span> <span class="mf">5.565</span><span class="p">,</span> <span class="mf">5.572</span><span class="p">,</span> <span class="mf">5.572</span><span class="p">,</span>
                              <span class="mf">5.572</span><span class="p">,</span> <span class="mf">5.572</span><span class="p">,</span> <span class="mf">5.6008</span><span class="p">,</span> <span class="mf">5.6842</span><span class="p">,</span> <span class="mf">5.815</span><span class="p">,</span> <span class="mf">5.9821</span><span class="p">,</span> <span class="mf">6.171</span><span class="p">,</span> <span class="mf">6.3655</span><span class="p">,</span>
                              <span class="mf">6.267</span><span class="p">],</span>
                     <span class="s1">&#39;ZLIM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">3.036</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.247</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.332</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.411</span><span class="p">,</span> <span class="mf">0.643</span><span class="p">,</span> <span class="mf">1.691</span><span class="p">,</span> <span class="mf">2.474</span><span class="p">,</span>
                              <span class="mf">3.189</span><span class="p">,</span> <span class="mf">3.904</span><span class="p">,</span> <span class="mf">4.542</span><span class="p">,</span> <span class="mf">4.722</span><span class="p">,</span> <span class="mf">4.334</span><span class="p">,</span> <span class="mf">3.592</span><span class="p">,</span> <span class="mf">2.576</span><span class="p">,</span>
                              <span class="mf">1.559</span><span class="p">,</span> <span class="mf">0.543</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.474</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.49</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.496</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5284</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5284</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">2.5574</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.6414</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.7708</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.931</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.1039</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2701</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.3943</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">3.3948</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.4699</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.6048</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.7397</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8747</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8992</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8176</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">3.736</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.699</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.7314</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8282</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.9752</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.1144</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.2536</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">4.5459</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.3926</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.2394</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0862</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.9861</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.9856</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.886</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">3.885</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.6924</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.5165</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.3723</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2722</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.225</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2346</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">3.036</span><span class="p">]}</span>

    <span class="k">if</span> <span class="n">machine</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">walls</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s1">&#39;OMAS wall information only available for: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">walls</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall.description_2d.+.limiter.type.name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;first_wall&#39;</span>
    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall.description_2d.-1.limiter.type.index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall.description_2d.-1.limiter.type.description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;first wall&#39;</span>
    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall.description_2d.-1.limiter.unit.0.outline.r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">walls</span><span class="p">[</span><span class="n">machine</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s1">&#39;RLIM&#39;</span><span class="p">]</span>
    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall.description_2d.-1.limiter.unit.0.outline.z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">walls</span><span class="p">[</span><span class="n">machine</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s1">&#39;ZLIM&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="equilibrium_consistent"><a class="viewcode-back" href="../../code/omas.omas_physics.html#omas.equilibrium_consistent">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">equilibrium_consistent</span><span class="p">(</span><span class="n">ods</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate missing derived quantities for equilibrium IDS</span>

<span class="sd">    :param ods: ODS to update in-place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">]:</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="n">eq1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]</span>

        <span class="n">psi</span> <span class="o">=</span> <span class="n">eq1d</span><span class="p">[</span><span class="s1">&#39;psi&#39;</span><span class="p">]</span>
        <span class="n">psi_norm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">psi</span> <span class="o">-</span> <span class="n">psi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">psi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">psirz</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.psi&#39;</span><span class="p">]</span>
        <span class="n">psirz_norm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">psirz</span> <span class="o">-</span> <span class="n">psi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">psi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fpol</span> <span class="o">=</span> <span class="n">eq1d</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span>

        <span class="c1"># extend functions in PSI to be clamped at edge value when outside of PSI range (i.e. outside of LCFS)</span>
        <span class="n">ext_psi_norm_mesh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">psi_norm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1E6</span><span class="p">,</span> <span class="n">psi_norm</span><span class="p">,</span> <span class="n">psi_norm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1E6</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">ext_arr</span><span class="p">(</span><span class="n">inv</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">inv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inv</span><span class="p">,</span> <span class="n">inv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">fpol</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">psirz_norm</span><span class="p">,</span> <span class="n">ext_psi_norm_mesh</span><span class="p">,</span> <span class="n">ext_arr</span><span class="p">(</span><span class="n">fpol</span><span class="p">))</span>
        <span class="n">Z</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.grid.dim2&#39;</span><span class="p">],</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.grid.dim1&#39;</span><span class="p">])</span>
        <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>
        <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span>
        <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.b_field_tor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpol</span> <span class="o">/</span> <span class="n">R</span>

    <span class="k">return</span> <span class="n">ods</span></div>


<div class="viewcode-block" id="equilibrium_transpose_RZ"><a class="viewcode-back" href="../../code/omas.omas_physics.html#omas.equilibrium_transpose_RZ">[docs]</a><span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">equilibrium_transpose_RZ</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">flip_dims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Transpose 2D grid values for RZ grids under equilibrium.time_slice.:.profiles_2d.:.</span>

<span class="sd">    :param ods: ODS to update in-place</span>

<span class="sd">    :param flip_dims: whether to switch the equilibrium.time_slice.:.profiles_2d.:.grid.dim1 and dim1</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="n">grid</span><span class="p">][</span><span class="s1">&#39;grid_type.index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">eq2D</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="n">grid</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">eq2D</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eq2D</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">eq2D</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">eq2D</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq2D</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

                <span class="k">if</span> <span class="n">flip_dims</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">eq2D</span><span class="p">[</span><span class="s1">&#39;grid.dim1&#39;</span><span class="p">]</span>
                    <span class="n">eq2D</span><span class="p">[</span><span class="s1">&#39;grid.dim1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ed2D</span><span class="p">[</span><span class="s1">&#39;grid.dim2&#39;</span><span class="p">]</span>
                    <span class="n">eq2D</span><span class="p">[</span><span class="s1">&#39;grid.dim1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
    <span class="k">return</span> <span class="n">ods</span></div>


<div class="viewcode-block" id="transform_current"><a class="viewcode-back" href="../../code/omas.transform_current.html#omas.transform_current">[docs]</a><span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">transform_current</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">JtoR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">JparB</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equilibrium</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">includes_bootstrap</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given &lt;Jt/R&gt; returns &lt;J.B&gt;, or vice versa</span>
<span class="sd">    Transformation obeys &lt;J.B&gt; = (1/f)*(&lt;B^2&gt;/&lt;1/R^2&gt;)*(&lt;Jt/R&gt; + dp/dpsi*(1 - f^2*&lt;1/R^2&gt;/&lt;B^2&gt;))</span>
<span class="sd">    N.B. input current must be in the same COCOS as equilibrium.cocosio</span>

<span class="sd">    :param rho: normalized rho grid for input JtoR or JparB</span>

<span class="sd">    :param JtoR: input &lt;Jt/R&gt; profile (cannot be set along with JparB)</span>

<span class="sd">    :param JparB: input &lt;J.B&gt; profile (cannot be set along with JtoR)</span>

<span class="sd">    :param equilibrium: equilibrium.time_slice[:] ODS containing quanities needed for transformation</span>

<span class="sd">    :param includes_bootstrap: set to True if input current includes bootstrap</span>

<span class="sd">    :return: &lt;Jt/R&gt; if JparB set or &lt;J.B&gt; if JtoR set</span>

<span class="sd">    Example: given total &lt;Jt/R&gt; on rho grid with an existing ods, return &lt;J.B&gt;</span>
<span class="sd">             JparB = transform_current(rho, JtoR=JtoR,</span>
<span class="sd">                                       equilibrium=ods[&#39;equilibrium&#39;][&#39;time_slice&#39;][0],</span>
<span class="sd">                                       includes_bootstrap=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">JtoR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">JparB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;JtoR and JparB cannot both be set&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">equilibrium</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;equilibrium ODS must be provided, specifically equilibrium.time_slice[:]&quot;</span><span class="p">)</span>

    <span class="n">cocos</span> <span class="o">=</span> <span class="n">define_cocos</span><span class="p">(</span><span class="n">equilibrium</span><span class="o">.</span><span class="n">cocosio</span><span class="p">)</span>
    <span class="n">rho_eq</span> <span class="o">=</span> <span class="n">equilibrium</span><span class="p">[</span><span class="s1">&#39;profiles_1d.rho_tor_norm&#39;</span><span class="p">]</span>
    <span class="n">fsa_B2</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">rho_eq</span><span class="p">,</span> <span class="n">equilibrium</span><span class="p">[</span><span class="s1">&#39;profiles_1d.gm5&#39;</span><span class="p">])</span>
    <span class="n">fsa_invR2</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">rho_eq</span><span class="p">,</span> <span class="n">equilibrium</span><span class="p">[</span><span class="s1">&#39;profiles_1d.gm1&#39;</span><span class="p">])</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">rho_eq</span><span class="p">,</span> <span class="n">equilibrium</span><span class="p">[</span><span class="s1">&#39;profiles_1d.f&#39;</span><span class="p">])</span>
    <span class="n">dpdpsi</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">rho_eq</span><span class="p">,</span> <span class="n">equilibrium</span><span class="p">[</span><span class="s1">&#39;profiles_1d.dpressure_dpsi&#39;</span><span class="p">])</span>

    <span class="c1"># diamagnetic term to get included with bootstrap currrent</span>
    <span class="n">JtoR_dia</span> <span class="o">=</span> <span class="n">dpdpsi</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fsa_invR2</span> <span class="o">*</span> <span class="n">f</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">fsa_B2</span><span class="p">)</span>
    <span class="n">JtoR_dia</span> <span class="o">*=</span> <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">JtoR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Jout</span> <span class="o">=</span> <span class="n">fsa_B2</span> <span class="o">*</span> <span class="p">(</span><span class="n">JtoR</span> <span class="o">+</span> <span class="n">includes_bootstrap</span> <span class="o">*</span> <span class="n">JtoR_dia</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">fsa_invR2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">JparB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Jout</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">fsa_invR2</span> <span class="o">*</span> <span class="n">JparB</span> <span class="o">/</span> <span class="n">fsa_B2</span> <span class="o">-</span> <span class="n">includes_bootstrap</span> <span class="o">*</span> <span class="n">JtoR_dia</span>

    <span class="k">return</span> <span class="n">Jout</span></div>


<div class="viewcode-block" id="search_ion"><a class="viewcode-back" href="../../code/omas.search_ion.html#omas.search_ion">[docs]</a><span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">search_ion</span><span class="p">(</span><span class="n">ion_ods</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_matches_raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multiple_matches_raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    utility function used to identify the ion number and element numbers given the ion label and or their Z and/or A</span>

<span class="sd">    :param ion_ods: ODS location that ends with .ion</span>

<span class="sd">    :param label: ion label</span>

<span class="sd">    :param Z: ion element charge</span>

<span class="sd">    :param A: ion element mass</span>

<span class="sd">    :parame no_matches_raise_error: whether to raise a IndexError when no ion matches are found</span>

<span class="sd">    :parame multiple_matches_raise_error: whether to raise a IndexError when multiple ion matches are found</span>

<span class="sd">    :return: dictionary with matching ions labels, each with list of matching ion elements</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ion_ods</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ion&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ods location must end with `.ion`&#39;</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">ion_ods</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">A</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;element&#39;</span> <span class="ow">in</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">A</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">A</span> <span class="o">==</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">][</span><span class="n">ke</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Z</span> <span class="o">==</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">][</span><span class="n">ke</span><span class="p">][</span><span class="s1">&#39;z_n&#39;</span><span class="p">]:</span>
                        <span class="n">match</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">A</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">A</span> <span class="o">==</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">][</span><span class="n">ke</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]:</span>
                        <span class="n">match</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Z</span> <span class="o">==</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">][</span><span class="n">ke</span><span class="p">][</span><span class="s1">&#39;z_n&#39;</span><span class="p">]:</span>
                        <span class="n">match</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;element&#39;</span> <span class="ow">in</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">]):</span>
                <span class="n">match</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">match</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">multiple_matches_raise_error</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Multiple ion match query: label=</span><span class="si">%s</span><span class="s1">  Z=</span><span class="si">%s</span><span class="s1">  A=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">no_matches_raise_error</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;No ion match query: label=</span><span class="si">%s</span><span class="s1">  Z=</span><span class="si">%s</span><span class="s1">  A=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">match</span></div>


<div class="viewcode-block" id="search_in_array_structure"><a class="viewcode-back" href="../../code/omas.search_in_array_structure.html#omas.search_in_array_structure">[docs]</a><span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">search_in_array_structure</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">no_matches_return</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">no_matches_raise_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multiple_matches_raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    search for the index in an array structure that matches some conditions</span>

<span class="sd">    :param ods: ODS location that is an array of structures</span>

<span class="sd">    :param conditions: dictionary (or ODS) whith entries that must match and their values</span>
<span class="sd">                       * condition[&#39;name&#39;]=value  : check value</span>
<span class="sd">                       * condition[&#39;name&#39;]=True   : check existance</span>
<span class="sd">                       * condition[&#39;name&#39;]=False  : check not existance</span>
<span class="sd">                       NOTE: True/False as flags for (not)existance is not an issue since IMAS does not support booleans</span>

<span class="sd">    :param no_matches_return: what index to return if no matches are found</span>

<span class="sd">    :param no_matches_raise_error: wheter to raise an error in no matches are found</span>

<span class="sd">    :param multiple_matches_raise_error: whater to raise an error if multiple matches are found</span>

<span class="sd">    :return: list with indeces matching conditions</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">ods</span><span class="o">.</span><span class="n">omas_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">omas_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ods location must be an array of structures&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">ODS</span><span class="p">):</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="n">conditions</span><span class="o">.</span><span class="n">flat</span><span class="p">()</span>

    <span class="n">match</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">k_match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conditions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">k_match</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">elif</span> <span class="n">conditions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">k_match</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ods</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">conditions</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="n">k_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">k_match</span><span class="p">:</span>
            <span class="n">match</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">no_matches_raise_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;no matches for conditions: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">conditions</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">no_matches_return</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">multiple_matches_raise_error</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;multiple matches for conditions: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">conditions</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match</span></div>


<div class="viewcode-block" id="define_cocos"><a class="viewcode-back" href="../../code/omas.omas_physics.html#omas.define_cocos">[docs]</a><span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">define_cocos</span><span class="p">(</span><span class="n">cocos_ind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns dictionary with COCOS coefficients given a COCOS index</span>

<span class="sd">    https://docs.google.com/document/d/1-efimTbI55SjxL_yE_GKSmV4GEvdzai7mAj5UYLLUXw/edit</span>

<span class="sd">    :param cocos_ind: COCOS index</span>

<span class="sd">    :return: dictionary with COCOS coefficients</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cocos</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">,</span> <span class="s1">&#39;sign_q_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;exp_Bp&#39;</span><span class="p">])</span>

    <span class="c1"># all multipliers shouldn&#39;t change input values if cocos_ind is None</span>
    <span class="k">if</span> <span class="n">cocos_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">cocos</span>

    <span class="c1"># if COCOS&gt;=10, this should be 1</span>
    <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">cocos_ind</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="c1"># (1)  psitbx(various options), Toray-GA</span>
        <span class="c1"># (11) ITER, Boozer</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="c1"># (2)  CHEASE, ONETWO, HintonHazeltine, LION, XTOR, MEUDAS, MARS, MARS-F</span>
        <span class="c1"># (12) GENE</span>
        <span class="c1"># (-12) ASTRA</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="c1"># (3) Freidberg*, CAXE and KINX*, GRAY, CQL3D^, CarMa, EFIT* with : ORB5, GBSwith : GT5D</span>
        <span class="c1"># (13) 	CLISTE, EQUAL, GEC, HELENA, EU ITM-TF up to end of 2011</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="c1"># (5) TORBEAM, GENRAY^</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">17</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="c1"># (17) LIUQE*, psitbx(TCV standard output)</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">cocos</span></div>


<div class="viewcode-block" id="cocos_transform"><a class="viewcode-back" href="../../code/omas.omas_physics.html#omas.cocos_transform">[docs]</a><span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">cocos_transform</span><span class="p">(</span><span class="n">cocosin_index</span><span class="p">,</span> <span class="n">cocosout_index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dictionary with coefficients for how various quantities should get multiplied in order to go from cocosin_index to cocosout_index</span>

<span class="sd">    https://docs.google.com/document/d/1-efimTbI55SjxL_yE_GKSmV4GEvdzai7mAj5UYLLUXw/edit</span>

<span class="sd">    :param cocosin_index: COCOS index in</span>

<span class="sd">    :param cocosout_index: COCOS index out</span>

<span class="sd">    :return: dictionary with transformation multipliers</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Don&#39;t transform if either cocos is undefined</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cocosin_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cocosout_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">printd</span><span class="p">(</span><span class="s2">&quot;No COCOS tranformation for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cocosin_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cocosout_index</span><span class="p">),</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;cocos&#39;</span><span class="p">)</span>
        <span class="n">sigma_Ip_eff</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">sigma_B0_eff</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">sigma_Bp_eff</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">exp_Bp_eff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sigma_rhotp_eff</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">printd</span><span class="p">(</span><span class="s2">&quot;COCOS tranformation from &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cocosin_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cocosout_index</span><span class="p">),</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;cocos&#39;</span><span class="p">)</span>
        <span class="n">cocosin</span> <span class="o">=</span> <span class="n">define_cocos</span><span class="p">(</span><span class="n">cocosin_index</span><span class="p">)</span>
        <span class="n">cocosout</span> <span class="o">=</span> <span class="n">define_cocos</span><span class="p">(</span><span class="n">cocosout_index</span><span class="p">)</span>

        <span class="n">sigma_Ip_eff</span> <span class="o">=</span> <span class="n">cocosin</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cocosout</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span>
        <span class="n">sigma_B0_eff</span> <span class="o">=</span> <span class="n">cocosin</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cocosout</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span>
        <span class="n">sigma_Bp_eff</span> <span class="o">=</span> <span class="n">cocosin</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cocosout</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span>
        <span class="n">exp_Bp_eff</span> <span class="o">=</span> <span class="n">cocosout</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cocosin</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span>
        <span class="n">sigma_rhotp_eff</span> <span class="o">=</span> <span class="n">cocosin</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cocosout</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span>

    <span class="c1"># Transform</span>
    <span class="n">transforms</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;1/PSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_Ip_eff</span> <span class="o">*</span> <span class="n">sigma_Bp_eff</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="n">exp_Bp_eff</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;invPSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;1/PSI&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;dPSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;1/PSI&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;F_FPRIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;dPSI&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;PPRIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;dPSI&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;PSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_Ip_eff</span> <span class="o">*</span> <span class="n">sigma_Bp_eff</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="n">exp_Bp_eff</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_Ip_eff</span> <span class="o">*</span> <span class="n">sigma_B0_eff</span> <span class="o">*</span> <span class="n">sigma_rhotp_eff</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;TOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_B0_eff</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;BT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;TOR&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;IP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;TOR&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;TOR&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;POL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_B0_eff</span> <span class="o">*</span> <span class="n">sigma_rhotp_eff</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;POL&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">printd</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;cocos&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">transforms</span></div>


<div class="viewcode-block" id="omas_environment"><a class="viewcode-back" href="../../code/omas.omas_physics.html#omas.omas_environment">[docs]</a><span class="nd">@add_to__ALL__</span>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">cocosio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unitsio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_data_process_functions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmlcodeparams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Provides environment for data input/output to/from OMAS</span>

<span class="sd">    :param ods: ODS on which to operate</span>

<span class="sd">    :param cocosio: COCOS convention</span>

<span class="sd">    :param coordsio: dictionary/ODS with coordinates for data interpolation</span>

<span class="sd">    :param unitsio: True/False whether data read from OMAS should have units</span>

<span class="sd">    :param xmlcodeparams: view code.parameters as an XML string while in this environment</span>

<span class="sd">    :param kw: extra keywords set attributes of the ods (eg. &#39;consistency_check&#39;, &#39;dynamic_path_creation&#39;, &#39;imas_version&#39;)</span>

<span class="sd">    :return: ODS with environment set</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># turn simple coordsio dictionary into an ODS</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coordsio</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="k">import</span> <span class="n">ODS</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">(</span><span class="n">cocos</span><span class="o">=</span><span class="n">ods</span><span class="o">.</span><span class="n">cocos</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">dynamic_path_creation</span> <span class="o">=</span> <span class="s1">&#39;dynamic_array_structures&#39;</span>
        <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">cocosio</span><span class="o">=</span><span class="n">cocosio</span><span class="p">):</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">coordsio</span><span class="p">)</span>
        <span class="n">coordsio</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="k">if</span> <span class="n">cocosio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cocosio</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cocosio can only be an integer&#39;</span><span class="p">)</span>

    <span class="c1"># backup attributes</span>
    <span class="n">bkp_cocosio</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">cocosio</span>
    <span class="n">bkp_coordsio</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">coordsio</span>
    <span class="n">bkp_unitsio</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">unitsio</span>
    <span class="n">bkp_args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
        <span class="n">bkp_args</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="c1"># set attributes</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">kw</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">cocosio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">cocosio</span> <span class="o">=</span> <span class="n">cocosio</span>
    <span class="k">if</span> <span class="n">coordsio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">coordsio</span> <span class="o">=</span> <span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">unitsio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">unitsio</span> <span class="o">=</span> <span class="n">unitsio</span>

    <span class="c1"># set input_data_process_functions</span>
    <span class="k">if</span> <span class="n">input_data_process_functions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">omas_core</span>
        <span class="n">bkp_input_data_process_functions</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">omas_core</span><span class="o">.</span><span class="n">input_data_process_functions</span><span class="p">)</span>
        <span class="n">omas_core</span><span class="o">.</span><span class="n">input_data_process_functions</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">input_data_process_functions</span>

    <span class="c1"># set code.parameters as XML string</span>
    <span class="k">if</span> <span class="n">xmlcodeparams</span><span class="p">:</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">codeparams2xml</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">coordsio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">coordsio</span><span class="p">,</span> <span class="n">cocosio</span><span class="o">=</span><span class="n">cocosio</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">ods</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ods</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># restore code.parameters as dictionary</span>
        <span class="k">if</span> <span class="n">xmlcodeparams</span><span class="p">:</span>
            <span class="n">ods</span><span class="o">.</span><span class="n">codeparams2dict</span><span class="p">()</span>
        <span class="c1"># restore attributes</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">cocosio</span> <span class="o">=</span> <span class="n">bkp_cocosio</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">coordsio</span> <span class="o">=</span> <span class="n">bkp_coordsio</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">unitsio</span> <span class="o">=</span> <span class="n">bkp_unitsio</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">bkp_args</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
        <span class="c1"># restore input_data_process_functions</span>
        <span class="k">if</span> <span class="n">input_data_process_functions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">omas_core</span><span class="o">.</span><span class="n">input_data_process_functions</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">bkp_input_data_process_functions</span></div>

<span class="k">def</span> <span class="nf">generate_cocos_signals</span><span class="p">(</span><span class="n">structures</span><span class="o">=</span><span class="p">[],</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a utility function for generating the omas_cocos.py Python file</span>

<span class="sd">    :param structures: list of structures for which to generate COCOS signals</span>

<span class="sd">    :param threshold: score threshold below which singals entries will not be written in omas_cocos.py</span>
<span class="sd">    * 0 is a reasonable threshold for catching signals that should have an associated COCOS transform</span>
<span class="sd">    * 10000 (or any high number) is a way to hide signals in omas_cocos.py that are unassigned</span>

<span class="sd">    :param write: update omas_cocos.py file</span>

<span class="sd">    :param verbose: print cocos signals to screen</span>

<span class="sd">    :return: dictionary structure with tally of score and reason for scoring for every entry</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># units of entries currently in cocos_singals</span>
    <span class="n">cocos_units</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cocos_signals</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cocos_signals</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">omas_info_node</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>  <span class="c1"># info may have no length if nodes are deleted between IMAS versions</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">units</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cocos_units</span><span class="p">:</span>
                <span class="n">cocos_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    <span class="n">cocos_units</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cocos_units</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;?&#39;</span><span class="p">]))</span>

    <span class="c1"># make sure to keep around structures that are already in omas_cocos.py</span>
    <span class="n">cocos_structures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">_cocos_signals</span><span class="p">:</span>
        <span class="n">structure_name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">structure_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cocos_structures</span><span class="p">:</span>
            <span class="n">cocos_structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">structure_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">structures</span> <span class="o">=</span> <span class="p">[</span><span class="n">structures</span><span class="p">]</span>
    <span class="n">structures</span> <span class="o">+=</span> <span class="n">cocos_structures</span>
    <span class="n">structures</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">.omas_utils</span> <span class="k">import</span> <span class="n">_structures</span>
    <span class="kn">from</span> <span class="nn">.omas_utils</span> <span class="k">import</span> <span class="n">i2o</span>
    <span class="kn">from</span> <span class="nn">.omas_core</span> <span class="k">import</span> <span class="n">ODS</span>
    <span class="n">ods</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">text</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">csig</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&#39;&#39;&#39;List of automatic COCOS transformations</span>

<span class="s2">-------</span>
<span class="s2">&#39;&#39;&#39;</span>
<span class="s2"># COCOS signals candidates are generated by running utilities/generate_cocos_signals.py</span>
<span class="s2"># Running this script is useful to keep track of new signals that IMAS adds in new data structure releases</span>
<span class="s2">#</span>
<span class="s2"># In this file you are only allowed to edit/add entries to the `cocos_signals` dictionary</span>
<span class="s2"># The comments indicate `#[ADD_OR_DELETE_SUGGESTION]# MATCHING_SCORE # RATIONALE_FOR_ADD_OR_DELETE`</span>
<span class="s2">#</span>
<span class="s2"># Proceed as follows:</span>
<span class="s2"># 1. Edit transformations in this file (if a signal is missing, it can be added here)</span>
<span class="s2"># 2. Run `utilities/generate_cocos_signals.py` (which will update this same file)</span>
<span class="s2"># 3. Commit changes</span>
<span class="s2">#</span>
<span class="s2"># Valid transformations are defined in the `cocos_transform()` function and they are:</span>
<span class="s2">#</span>
<span class="s2">#        transforms = </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">#        transforms[&#39;1/PSI&#39;] = sigma_Ip_eff * sigma_Bp_eff / (2 * numpy.pi) ** exp_Bp_eff</span>
<span class="s2">#        transforms[&#39;invPSI&#39;] = transforms[&#39;1/PSI&#39;]</span>
<span class="s2">#        transforms[&#39;dPSI&#39;] = transforms[&#39;1/PSI&#39;]</span>
<span class="s2">#        transforms[&#39;F_FPRIME&#39;] = transforms[&#39;dPSI&#39;]</span>
<span class="s2">#        transforms[&#39;PPRIME&#39;] = transforms[&#39;dPSI&#39;]</span>
<span class="s2">#        transforms[&#39;PSI&#39;] = sigma_Ip_eff * sigma_Bp_eff * (2 * numpy.pi) ** exp_Bp_eff</span>
<span class="s2">#        transforms[&#39;Q&#39;] = sigma_Ip_eff * sigma_B0_eff * sigma_rhotp_eff</span>
<span class="s2">#        transforms[&#39;TOR&#39;] = sigma_B0_eff</span>
<span class="s2">#        transforms[&#39;BT&#39;] = transforms[&#39;TOR&#39;]</span>
<span class="s2">#        transforms[&#39;IP&#39;] = transforms[&#39;TOR&#39;]</span>
<span class="s2">#        transforms[&#39;F&#39;] = transforms[&#39;TOR&#39;]</span>
<span class="s2">#        transforms[&#39;POL&#39;] = sigma_B0_eff * sigma_rhotp_eff</span>
<span class="s2">#        transforms[&#39;BP&#39;] = transforms[&#39;POL&#39;]</span>
<span class="s2">#        transforms[None] = 1</span>
<span class="s2">#</span>
<span class="s2">                </span>
<span class="s2">cocos_signals = </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">]</span>

    <span class="c1"># loop over structures</span>
    <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">structures</span><span class="p">:</span>
        <span class="n">text</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;# &#39;</span> <span class="o">+</span> <span class="n">structure</span><span class="o">.</span><span class="n">upper</span><span class="p">()])</span>
        <span class="n">csig</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;# &#39;</span> <span class="o">+</span> <span class="n">structure</span><span class="o">.</span><span class="n">upper</span><span class="p">()])</span>

        <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ods</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">dict_structures</span><span class="p">(</span><span class="n">imas_version</span><span class="o">=</span><span class="n">omas_rcparams</span><span class="p">[</span><span class="s1">&#39;default_imas_version&#39;</span><span class="p">])</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># generate score and add reason for scoring</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_structures</span><span class="p">[(</span><span class="n">structure</span><span class="p">,</span> <span class="n">omas_rcparams</span><span class="p">[</span><span class="s1">&#39;default_imas_version&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">i2o</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">item_</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;:.values&#39;</span><span class="p">,</span> <span class="s1">&#39;:.value&#39;</span><span class="p">,</span> <span class="s1">&#39;:.data&#39;</span><span class="p">]]):</span>
                <span class="n">item_</span> <span class="o">=</span> <span class="n">l2o</span><span class="p">(</span><span class="n">p2l</span><span class="p">(</span><span class="n">item</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">([</span><span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.values&#39;</span><span class="p">,</span> <span class="s1">&#39;.value&#39;</span><span class="p">,</span> <span class="s1">&#39;.data&#39;</span><span class="p">]]):</span>
                <span class="n">item_</span> <span class="o">=</span> <span class="n">l2o</span><span class="p">(</span><span class="n">p2l</span><span class="p">(</span><span class="n">item</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">m</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">rationale</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;_error_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="s2">&quot;cocos_signals[&#39;</span><span class="si">%s</span><span class="s2">&#39;]=&quot;</span> <span class="o">%</span> <span class="n">i2o</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">omas_info_node</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">documentation</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;documentation&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">,</span> <span class="s1">&#39;STR_0D&#39;</span><span class="p">,</span> <span class="s1">&#39;struct_array&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">units</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">any</span><span class="p">([(</span><span class="n">item_</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item_</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                          <span class="p">[</span><span class="s1">&#39;chi_squared&#39;</span><span class="p">,</span> <span class="s1">&#39;standard_deviation&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;coefficients&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_tor&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;beta_pol&#39;</span><span class="p">,</span> <span class="s1">&#39;radial&#39;</span><span class="p">,</span> <span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;darea_drho_tor&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;dvolume_drho_tor&#39;</span><span class="p">,</span> <span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;fraction&#39;</span><span class="p">,</span> <span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;b_field_max&#39;</span><span class="p">,</span> <span class="s1">&#39;width_tor&#39;</span><span class="p">]]):</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">p2l</span><span class="p">(</span><span class="n">item_</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">any</span><span class="p">([</span><span class="n">k</span> <span class="ow">in</span> <span class="n">documentation</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;always positive&#39;</span><span class="p">]]):</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">documentation</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pnt</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p2l</span><span class="p">(</span><span class="n">item</span><span class="p">)):</span>
                    <span class="n">pnt</span> <span class="o">=</span> <span class="n">pnt</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;ip&#39;</span><span class="p">,</span> <span class="s1">&#39;b0&#39;</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="s1">&#39;psi&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f_df&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">case</span><span class="p">:</span>
                            <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="n">case</span><span class="p">]</span>
                            <span class="n">score</span> <span class="o">+=</span> <span class="n">pnt</span>
                            <span class="k">break</span>
                    <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="s1">&#39;psi&#39;</span><span class="p">,</span> <span class="s1">&#39;ip&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;f_df&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_&#39;</span> <span class="o">%</span> <span class="n">case</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;psi_norm&#39;</span><span class="p">]]):</span>
                            <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="n">case</span><span class="p">]</span>
                            <span class="n">score</span> <span class="o">+=</span> <span class="n">pnt</span>
                            <span class="k">break</span>
                    <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="s1">&#39;b_field&#39;</span><span class="p">,</span> <span class="s1">&#39;e_field&#39;</span><span class="p">,</span> <span class="s1">&#39;torque&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;heating_current_drive&#39;</span><span class="p">]:</span>
                            <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="n">case</span><span class="p">]</span>
                            <span class="n">score</span> <span class="o">+=</span> <span class="n">pnt</span>
                            <span class="k">break</span>
                    <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_dpsi&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">case</span> <span class="o">+</span> <span class="s1">&#39;_norm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                            <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="n">case</span><span class="p">]</span>
                            <span class="n">score</span> <span class="o">+=</span> <span class="n">pnt</span>
                            <span class="k">break</span>
                    <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;poloidal&#39;</span><span class="p">,</span> <span class="s1">&#39;toroidal&#39;</span><span class="p">,</span> <span class="s1">&#39;parallel&#39;</span><span class="p">,</span> <span class="s1">&#39;_tor&#39;</span><span class="p">,</span> <span class="s1">&#39;_pol&#39;</span><span class="p">,</span> <span class="s1">&#39;_par&#39;</span><span class="p">,</span> <span class="s1">&#39;tor_&#39;</span><span class="p">,</span> <span class="s1">&#39;pol_&#39;</span><span class="p">,</span> <span class="s1">&#39;par_&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">case</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">case</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conductivity_&#39;</span><span class="p">,</span> <span class="s1">&#39;pressure_&#39;</span><span class="p">,</span> <span class="s1">&#39;rho_&#39;</span><span class="p">,</span> <span class="s1">&#39;length_&#39;</span><span class="p">]])):</span>
                            <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="n">case</span><span class="p">]</span>
                            <span class="n">score</span> <span class="o">+=</span> <span class="n">pnt</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">units</span> <span class="ow">in</span> <span class="n">cocos_units</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rationale</span><span class="p">):</span>
                        <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">units</span><span class="p">]</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rationale</span><span class="p">)))</span>

        <span class="c1"># generate output</span>
        <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">])):</span>
            <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">rationale</span> <span class="ow">in</span> <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">][</span><span class="n">score</span><span class="p">]:</span>

                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;       &#39;</span>
                <span class="k">if</span> <span class="n">cocos_signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;#[ADD?]&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;#[DEL?]&#39;</span>
                <span class="k">elif</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;#[DEL?]&#39;</span>

                <span class="n">transform</span> <span class="o">=</span> <span class="n">cocos_signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
                <span class="n">transform</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">transform</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;cocos_signals[&#39;</span><span class="si">%s</span><span class="s2">&#39;]=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">transform</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s1">&#39;# </span><span class="si">%f</span><span class="s1"> # </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">rationale</span><span class="p">)</span>
                <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">cocos_signals</span> <span class="ow">and</span> <span class="n">cocos_signals</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;?&#39;</span><span class="p">):</span>
                    <span class="n">csig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="c1"># print to screen (note that this prints ALL the entries, whereas omas_cocos.py only contains entries that score above a give threshold)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/omas_cocos.py&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
        <span class="c1"># update omas_cocos.py</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">csig</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># check that omas_cocos.py file is up-to-date</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">original</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">csig</span><span class="p">))</span>
        <span class="kn">import</span> <span class="nn">difflib</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">unified_diff</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">original</span> <span class="o">==</span> <span class="n">new</span><span class="p">,</span> <span class="s1">&#39;COCOS signals are not up-to-date! Run `make cocos` to update the omas_cocos.py file.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="c1"># cocos_signals contains the IMAS locations and the corresponding `cocos_transform` function</span>
<span class="kn">from</span> <span class="nn">.omas_cocos</span> <span class="k">import</span> <span class="n">cocos_signals</span> <span class="k">as</span> <span class="n">_cocos_signals</span>


<span class="c1"># The CocosSignals class is just a dictionary that raises warnings when users access</span>
<span class="c1"># entries that are likely to need a COCOS transformation, but do not have one.</span>
<span class="k">class</span> <span class="nc">CocosSignals</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">` may require defining its COCOS transform in omas/omas_cocos.py&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="c1"># cocos_signals is the actual dictionary</span>
<span class="n">cocos_signals</span> <span class="o">=</span> <span class="n">CocosSignals</span><span class="p">()</span>
<span class="n">cocos_signals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_cocos_signals</span><span class="p">)</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2017-2019 O. Meneghini and collaborators.<br/>
      Last updated on Nov 19, 2019.<br/>
    </p>
  </div>
</footer>
  </body>
</html>